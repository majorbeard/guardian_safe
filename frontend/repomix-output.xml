This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
index.html
package.json
public/vite.svg
src/app.tsx
src/components/AdminDashboard.tsx
src/components/ChangePasswordModal.tsx
src/components/CreateSafeModal.tsx
src/components/CreateTripModal.tsx
src/components/CreateUserModal.tsx
src/components/CustomerTrackingPage.tsx
src/components/DashboardLayout.tsx
src/components/LiveTracking.tsx
src/components/LoadingSpinner.tsx
src/components/LoginPage.tsx
src/components/OwnerDashboard.tsx
src/components/SafesList.tsx
src/components/StatsCards.tsx
src/components/TripsList.tsx
src/components/TripTrackingModal.tsx
src/components/UsersList.tsx
src/index.css
src/lib/supabase.ts
src/main.tsx
src/services/auth.ts
src/services/data.ts
src/services/mobileUsers.ts
src/services/tracknetics.ts
src/store/auth.ts
src/store/data.ts
src/types/index.ts
src/utils/leafletHelpers.ts
src/vite-env.d.ts
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Environment variables
.env
.env.local
.env.production

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guardian Safe</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="package.json">
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@preact/signals": "^2.3.1",
    "@supabase/supabase-js": "^2.57.2",
    "@tailwindcss/vite": "^4.1.12",
    "@types/leaflet": "^1.9.21",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "leaflet": "^1.9.4",
    "lucide-preact": "^0.541.0",
    "lucide-react": "^0.542.0",
    "preact": "^10.27.0"
  },
  "devDependencies": {
    "@preact/preset-vite": "^2.10.2",
    "typescript": "~5.8.3",
    "vite": "^7.1.2"
  }
}
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="src/app.tsx">
import { useEffect, useMemo } from "preact/hooks";
import { authService } from "./services/auth";
import { dataService } from "./services/data";
import { isAuthenticated, isLoading, currentUser } from "./store/auth";
import { LoginPage } from "./components/LoginPage";
import { OwnerDashboard } from "./components/OwnerDashboard";
import { AdminDashboard } from "./components/AdminDashboard";
import { CustomerTrackingPage } from "./components/CustomerTrackingPage";
import { ChangePasswordModal } from "./components/ChangePasswordModal";
import { LoadingSpinner } from "./components/LoadingSpinner";

export function App() {
  const authenticated = isAuthenticated.value;
  const loading = isLoading.value;
  const user = currentUser.value;

  // Simple client-side routing
  const currentPath = useMemo(() => {
    return window.location.pathname;
  }, [window.location.pathname]);

  const trackingToken = useMemo(() => {
    const match = currentPath.match(/^\/track\/([^\/]+)$/);
    return match ? match[1] : null;
  }, [currentPath]);

  useEffect(() => {
    // Initialize auth and data services
    authService.initialize();
  }, []);

  useEffect(() => {
    // Load data when user is authenticated
    if (authenticated && user) {
      dataService.loadUserData();
      dataService.setupRealtimeSubscriptions();
    }
  }, [authenticated, user]);

  // Handle customer tracking route (public access)
  if (trackingToken) {
    return <CustomerTrackingPage trackingToken={trackingToken} />;
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <LoadingSpinner size="large" />
      </div>
    );
  }

  if (!authenticated) {
    return <LoginPage />;
  }

  return (
    <>
      {user?.must_change_password && <ChangePasswordModal />}

      {user?.role === "owner" ? <OwnerDashboard /> : <AdminDashboard />}
    </>
  );
}

export default App;
</file>

<file path="src/components/AdminDashboard.tsx">
import { useState } from "preact/hooks";
import { Plus, Shield, Package, MapPin } from "lucide-preact";
import { DashboardLayout } from "./DashboardLayout";
import { CreateTripModal } from "./CreateTripModal";
import { SafesList } from "./SafesList";
import { TripsList } from "./TripsList";
import { StatsCards } from "./StatsCards";
import { LiveTracking } from "./LiveTracking";
import { safes, trips } from "../store/data";
import { currentUser } from "../store/auth";

export function AdminDashboard() {
  const [showCreateTrip, setShowCreateTrip] = useState(false);
  const [activeTab, setActiveTab] = useState<
    "overview" | "safes" | "trips" | "tracking"
  >("overview");

  const user = currentUser.value;
  const userSafes = safes.value.filter((safe) => safe.assigned_to === user?.id);
  const userTrips = trips.value;

  const stats = {
    totalSafes: userSafes.length,
    activeSafes: userSafes.filter((s) => s.status === "active").length,
    totalTrips: userTrips.length,
    activeTrips: userTrips.filter((t) => t.status === "in_transit").length,
  };

  const actions = (
    <button
      onClick={() => setShowCreateTrip(true)}
      className="btn btn-primary"
      disabled={userSafes.length === 0}
    >
      <Plus className="h-4 w-4 mr-2" />
      Book Trip
    </button>
  );

  const tabs = [
    { id: "overview", label: "Overview", icon: Package },
    { id: "safes", label: "My Safes", icon: Shield },
    { id: "trips", label: "My Trips", icon: Package },
    { id: "tracking", label: "Live Tracking", icon: MapPin },
  ];

  return (
    <>
      <DashboardLayout title="My Safes" actions={actions}>
        {/* Tab Navigation */}
        <div className="bg-white rounded-lg shadow mb-6">
          <div className="border-b border-gray-200">
            <nav className="-mb-px flex space-x-8 px-6">
              {tabs.map((tab) => {
                const IconComponent = tab.icon;
                return (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id as any)}
                    className={`py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2 ${
                      activeTab === tab.id
                        ? "border-blue-500 text-blue-600"
                        : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                    }`}
                  >
                    <IconComponent className="h-4 w-4" />
                    <span>{tab.label}</span>
                  </button>
                );
              })}
            </nav>
          </div>
        </div>

        {/* Tab Content */}
        {activeTab === "overview" && (
          <div className="space-y-6">
            <StatsCards stats={stats} />

            {userSafes.length === 0 ? (
              <div className="card text-center py-12">
                <Shield className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                <h3 className="text-lg font-medium text-gray-900 mb-2">
                  No Safes Assigned
                </h3>
                <p className="text-gray-500">
                  Contact your administrator to get safes assigned to your
                  account.
                </p>
              </div>
            ) : (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="card">
                  <h3 className="text-lg font-medium text-gray-900 mb-4">
                    My Safes
                  </h3>
                  <SafesList limit={5} showActions={false} />
                </div>

                <div className="card">
                  <h3 className="text-lg font-medium text-gray-900 mb-4">
                    Recent Trips
                  </h3>
                  <TripsList limit={5} showActions={false} />
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === "safes" && <SafesList />}
        {activeTab === "trips" && <TripsList />}
        {activeTab === "tracking" && <LiveTracking safes={userSafes} />}
      </DashboardLayout>

      {/* Modals */}
      {showCreateTrip && (
        <CreateTripModal
          onClose={() => setShowCreateTrip(false)}
          availableSafes={userSafes.filter((safe) => safe.status === "active")}
        />
      )}
    </>
  );
}
</file>

<file path="src/components/ChangePasswordModal.tsx">
import { useState } from "preact/hooks";
import { Lock, Eye, EyeOff } from "lucide-preact";
import { authService } from "../services/auth";
import { LoadingSpinner } from "./LoadingSpinner";

export function ChangePasswordModal() {
  const [newPassword, setNewPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const handleSubmit = async (e: Event) => {
    e.preventDefault();
    setError("");

    if (newPassword.length < 8) {
      setError("Password must be at least 8 characters long");
      return;
    }

    if (newPassword !== confirmPassword) {
      setError("Passwords do not match");
      return;
    }

    setLoading(true);

    try {
      const result = await authService.changePassword(newPassword);

      if (!result.success) {
        setError(result.error || "Failed to change password");
      }
      // Success will update auth state and close modal
    } catch (err) {
      setError("Network error. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div className="flex items-center space-x-3 mb-6">
          <div className="bg-yellow-100 rounded-full p-2">
            <Lock className="h-6 w-6 text-yellow-600" />
          </div>
          <div>
            <h2 className="text-xl font-bold text-gray-900">Change Password</h2>
            <p className="text-sm text-gray-600">
              You must change your password to continue
            </p>
          </div>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm">
              {error}
            </div>
          )}

          <div>
            <label
              htmlFor="newPassword"
              className="block text-sm font-medium text-gray-700"
            >
              New Password
            </label>
            <div className="mt-1 relative">
              <input
                id="newPassword"
                type={showPassword ? "text" : "password"}
                required
                className="input pr-10"
                placeholder="Enter new password"
                value={newPassword}
                onInput={(e) =>
                  setNewPassword((e.target as HTMLInputElement).value)
                }
              />
              <button
                type="button"
                className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                onClick={() => setShowPassword(!showPassword)}
              >
                {showPassword ? (
                  <EyeOff className="h-5 w-5" />
                ) : (
                  <Eye className="h-5 w-5" />
                )}
              </button>
            </div>
          </div>

          <div>
            <label
              htmlFor="confirmPassword"
              className="block text-sm font-medium text-gray-700"
            >
              Confirm Password
            </label>
            <input
              id="confirmPassword"
              type={showPassword ? "text" : "password"}
              required
              className="mt-1 input"
              placeholder="Confirm new password"
              value={confirmPassword}
              onInput={(e) =>
                setConfirmPassword((e.target as HTMLInputElement).value)
              }
            />
          </div>

          <div className="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-700">
            <p className="font-medium">Password requirements:</p>
            <ul className="mt-1 space-y-1">
              <li>â€¢ At least 8 characters long</li>
              <li>â€¢ Should contain letters and numbers</li>
              <li>â€¢ Avoid common passwords</li>
            </ul>
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full btn btn-primary"
          >
            {loading ? (
              <>
                <LoadingSpinner size="small" className="mr-2" />
                Changing Password...
              </>
            ) : (
              "Change Password"
            )}
          </button>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="src/components/CreateSafeModal.tsx">
import { useState, useEffect } from "preact/hooks";
import {
  X,
  Shield,
  Smartphone,
  User,
  Eye,
  EyeOff,
  Copy,
  MapPin,
  AlertTriangle,
  RefreshCw,
} from "lucide-preact";
import { dataService } from "../services/data";
import { trackneticsService } from "../services/tracknetics";
import {
  mobileUserService,
  type MobileUserCredentials,
} from "../services/mobileUsers";
import { LoadingSpinner } from "./LoadingSpinner";
import { safes } from "../store/data";
import { supabase } from "../lib/supabase";

interface CreateSafeModalProps {
  onClose: () => void;
}

interface AdminUser {
  id: string;
  username: string;
}

interface TrackerDevice {
  id: string;
  sn: string; // IMEI
  name: string;
  status: string;
  isAvailable: boolean;
}

export function CreateSafeModal({ onClose }: CreateSafeModalProps) {
  const [currentStep, setCurrentStep] = useState(1);
  const [formData, setFormData] = useState({
    serial_number: "",
    device_hash: "",
    selected_tracker_id: "",
    assigned_to: "",
    driver_name: "",
  });

  // State management
  const [adminUsers, setAdminUsers] = useState<AdminUser[]>([]);
  const [availableTrackers, setAvailableTrackers] = useState<TrackerDevice[]>(
    []
  );
  const [loading, setLoading] = useState(false);
  const [loadingUsers, setLoadingUsers] = useState(true);
  const [loadingTrackers, setLoadingTrackers] = useState(false);
  const [trackersError, setTrackersError] = useState("");
  const [error, setError] = useState("");

  // Credentials state
  const [mobileCredentials, setMobileCredentials] =
    useState<MobileUserCredentials | null>(null);
  const [showCredentials, setShowCredentials] = useState(false);

  useEffect(() => {
    loadAdminUsers();
  }, []);

  const loadAdminUsers = async () => {
    try {
      const { data, error } = await supabase
        .from("profiles")
        .select("id, username")
        .eq("role", "admin")
        .eq("is_active", true)
        .order("username");

      if (error) {
        console.error("Failed to load admin users:", error);
      } else {
        setAdminUsers(data || []);
      }
    } catch (err) {
      console.error("Error loading admin users:", err);
    } finally {
      setLoadingUsers(false);
    }
  };

  // Load available trackers from Tracknetics
  const loadAvailableTrackers = async () => {
    setLoadingTrackers(true);
    setTrackersError("");

    try {
      console.log("ðŸ” Fetching available trackers from Tracknetics...");

      // Get all devices from Tracknetics account
      const result = await trackneticsService.getDeviceList();

      if (!result.success || !result.devices) {
        throw new Error(result.error || "Failed to fetch tracking devices");
      }

      console.log(
        `ðŸ“± Found ${result.devices.length} trackers in Tracknetics account`
      );

      // Get trackers already assigned to safes in our database
      const assignedTrackerIds = safes.value
        .map((safe) => safe.tracknetics_device_id || safe.tracking_device_id)
        .filter(Boolean);

      console.log(
        `ðŸ”’ ${assignedTrackerIds.length} trackers already assigned to safes`
      );

      // Filter to show only available trackers
      const availableDevices: TrackerDevice[] = result.devices.map(
        (device) => ({
          id: device.id,
          sn: device.sn,
          name: device.name,
          status: device.status,
          isAvailable: !assignedTrackerIds.includes(device.id),
        })
      );

      const unassignedCount = availableDevices.filter(
        (d) => d.isAvailable
      ).length;
      console.log(`âœ… ${unassignedCount} trackers available for assignment`);

      setAvailableTrackers(availableDevices);

      if (unassignedCount === 0) {
        setTrackersError(
          "No available trackers found. All trackers are already assigned to safes."
        );
      }
    } catch (error: any) {
      console.error("âŒ Error loading trackers:", error);

      if (
        error.message?.includes("Authentication failed") ||
        error.message?.includes("login") ||
        error.message?.includes("KEY incorrect")
      ) {
        setTrackersError(
          "Unable to connect to tracking service provider. Please contact Tracknetics support to ensure your account is active and service is online."
        );
      } else {
        setTrackersError(
          error.message ||
            "Failed to load tracking devices. Please check your connection and try again."
        );
      }
    } finally {
      setLoadingTrackers(false);
    }
  };

  const generateDeviceHash = () => {
    const chars = "ABCDEF0123456789";
    let hash = "";
    for (let i = 0; i < 16; i++) {
      hash += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    setFormData((prev) => ({ ...prev, device_hash: hash }));
  };

  const handleStep1Submit = (e: Event) => {
    e.preventDefault();
    if (!formData.serial_number || !formData.assigned_to) {
      setError("Please fill in all required fields");
      return;
    }
    setCurrentStep(2);
    setError("");
    // Load trackers when moving to step 2
    loadAvailableTrackers();
  };

  const handleStep2Submit = (e: Event) => {
    e.preventDefault();
    if (!formData.selected_tracker_id || !formData.device_hash) {
      setError("Please select a tracker and generate device hash");
      return;
    }
    setCurrentStep(3);
    setError("");
  };

  const handleFinalSubmit = async (e: Event) => {
    e.preventDefault();
    setError("");
    setLoading(true);

    try {
      // Step 1: Create the safe
      const safeResult = await dataService.createSafe({
        serial_number: formData.serial_number,
        device_hash: formData.device_hash,
        tracking_device_id: formData.selected_tracker_id, // Store the selected tracker
        assigned_to: formData.assigned_to,
      });

      if (!safeResult.success) {
        setError(safeResult.error || "Failed to create safe");
        setLoading(false);
        return;
      }

      // Step 2: Create mobile app user
      const mobileUserResult = await mobileUserService.createMobileUser(
        safeResult.safe!.id,
        formData.serial_number,
        formData.driver_name
      );

      if (!mobileUserResult.success) {
        setError(
          `Safe created but failed to create mobile user: ${mobileUserResult.error}`
        );
        setLoading(false);
        return;
      }

      // Success! Show credentials
      setMobileCredentials(mobileUserResult.credentials!);
      setCurrentStep(4);
    } catch (err) {
      setError("Network error. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  const copyCredentials = () => {
    if (mobileCredentials) {
      const credentialsText = `Guardian Safe Mobile App Login:
Username: ${mobileCredentials.username}
Password: ${mobileCredentials.password}
      
Please save these credentials securely. The password will not be shown again.`;

      navigator.clipboard.writeText(credentialsText);
    }
  };

  const handleClose = () => {
    setCurrentStep(1);
    setFormData({
      serial_number: "",
      device_hash: "",
      selected_tracker_id: "",
      assigned_to: "",
      driver_name: "",
    });
    setAvailableTrackers([]);
    setMobileCredentials(null);
    setError("");
    setTrackersError("");
    onClose();
  };

  // Get selected tracker info
  const selectedTracker = availableTrackers.find(
    (t) => t.id === formData.selected_tracker_id
  );

  // Step 4: Show Credentials
  if (currentStep === 4 && mobileCredentials) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-xl font-bold text-gray-900">
              Safe Registered Successfully!
            </h2>
            <button
              onClick={handleClose}
              className="text-gray-400 hover:text-gray-600"
            >
              <X className="h-6 w-6" />
            </button>
          </div>

          <div className="space-y-4">
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <div className="flex items-center space-x-2 mb-3">
                <div className="bg-green-500 rounded-full p-1">
                  <Shield className="h-4 w-4 text-white" />
                </div>
                <h3 className="font-medium text-green-800">
                  Registration Complete
                </h3>
              </div>
              <div className="text-sm text-green-700 space-y-1">
                <p>
                  <strong>Safe:</strong> {formData.serial_number}
                </p>
                <p>
                  <strong>Tracker:</strong>{" "}
                  {selectedTracker?.name || formData.selected_tracker_id}
                </p>
                <p>
                  <strong>Status:</strong> Inactive (ready for activation)
                </p>
              </div>
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center space-x-2">
                  <Smartphone className="h-4 w-4 text-blue-600" />
                  <h3 className="font-medium text-blue-800">
                    Mobile App Credentials
                  </h3>
                </div>
                <button
                  onClick={() => setShowCredentials(!showCredentials)}
                  className="text-blue-600 hover:text-blue-800"
                >
                  {showCredentials ? (
                    <EyeOff className="h-4 w-4" />
                  ) : (
                    <Eye className="h-4 w-4" />
                  )}
                </button>
              </div>

              {showCredentials ? (
                <div className="space-y-3">
                  <div>
                    <p className="text-sm font-medium text-blue-700">
                      Username:
                    </p>
                    <p className="font-mono text-blue-900 bg-white px-2 py-1 rounded text-sm">
                      {mobileCredentials.username}
                    </p>
                  </div>
                  <div>
                    <p className="text-sm font-medium text-blue-700">
                      Password:
                    </p>
                    <p className="font-mono text-blue-900 bg-white px-2 py-1 rounded text-sm">
                      {mobileCredentials.password}
                    </p>
                  </div>
                  <button
                    onClick={copyCredentials}
                    className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center space-x-2"
                  >
                    <Copy className="h-4 w-4" />
                    <span>Copy Credentials</span>
                  </button>
                </div>
              ) : (
                <p className="text-sm text-blue-700">
                  Click the eye icon to view the mobile app login credentials.
                </p>
              )}
            </div>

            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <p className="text-sm text-yellow-800">
                <strong>Next Steps:</strong>
              </p>
              <ol className="text-sm text-yellow-700 mt-2 space-y-1 list-decimal list-inside">
                <li>Test the safe and tracker functionality</li>
                <li>Activate the safe from the Safes dashboard</li>
                <li>Provide mobile credentials to your driver</li>
              </ol>
            </div>

            <button onClick={handleClose} className="w-full btn btn-primary">
              Complete Registration
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-bold text-gray-900">
            {currentStep === 1
              ? "Register New Safe"
              : currentStep === 2
              ? "Select Tracking Device"
              : "Configure Mobile Access"}
          </h2>
          <button
            onClick={handleClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X className="h-6 w-6" />
          </button>
        </div>

        {/* Step Indicator */}
        <div className="flex items-center justify-center space-x-4 mb-6">
          <div
            className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
              currentStep >= 1
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-600"
            }`}
          >
            1
          </div>
          <div
            className={`h-1 w-8 ${
              currentStep >= 2 ? "bg-blue-600" : "bg-gray-200"
            }`}
          ></div>
          <div
            className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
              currentStep >= 2
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-600"
            }`}
          >
            2
          </div>
          <div
            className={`h-1 w-8 ${
              currentStep >= 3 ? "bg-blue-600" : "bg-gray-200"
            }`}
          ></div>
          <div
            className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
              currentStep >= 3
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-600"
            }`}
          >
            3
          </div>
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm mb-4">
            {error}
          </div>
        )}

        {/* Step 1: Basic Safe Info */}
        {currentStep === 1 && (
          <form onSubmit={handleStep1Submit} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700">
                Safe Serial Number *
              </label>
              <div className="mt-1 relative">
                <input
                  type="text"
                  required
                  className="input pl-10"
                  placeholder="GS-2025-001"
                  value={formData.serial_number}
                  onInput={(e) =>
                    setFormData((prev) => ({
                      ...prev,
                      serial_number: (
                        e.target as HTMLInputElement
                      ).value.toUpperCase(),
                    }))
                  }
                />
                <Shield className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700">
                Assign to Admin User *
              </label>
              <div className="mt-1">
                {loadingUsers ? (
                  <div className="flex items-center justify-center py-2">
                    <LoadingSpinner size="small" />
                    <span className="ml-2 text-sm text-gray-500">
                      Loading users...
                    </span>
                  </div>
                ) : (
                  <select
                    required
                    className="input"
                    value={formData.assigned_to}
                    onChange={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        assigned_to: (e.target as HTMLSelectElement).value,
                      }))
                    }
                  >
                    <option value="">Select an admin user</option>
                    {adminUsers.map((user) => (
                      <option key={user.id} value={user.id}>
                        {user.username}
                      </option>
                    ))}
                  </select>
                )}
              </div>
            </div>

            <div className="flex justify-end space-x-3 pt-4 border-t">
              <button
                type="button"
                onClick={handleClose}
                className="btn btn-secondary"
              >
                Cancel
              </button>
              <button type="submit" className="btn btn-primary">
                Continue
              </button>
            </div>
          </form>
        )}

        {/* Step 2: Tracker Selection */}
        {currentStep === 2 && (
          <form onSubmit={handleStep2Submit} className="space-y-4">
            <div>
              <div className="flex items-center justify-between mb-3">
                <label className="block text-sm font-medium text-gray-700">
                  Select GPS Tracker *
                </label>
                <button
                  type="button"
                  onClick={loadAvailableTrackers}
                  disabled={loadingTrackers}
                  className="text-blue-600 hover:text-blue-800 text-sm flex items-center space-x-1"
                >
                  <RefreshCw
                    className={`h-4 w-4 ${
                      loadingTrackers ? "animate-spin" : ""
                    }`}
                  />
                  <span>Refresh List</span>
                </button>
              </div>

              {loadingTrackers ? (
                <div className="flex items-center justify-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                  <div className="text-center">
                    <LoadingSpinner size="medium" />
                    <p className="mt-2 text-sm text-gray-500">
                      Fetching available trackers from Tracknetics...
                    </p>
                  </div>
                </div>
              ) : trackersError ? (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <div className="flex items-start space-x-3">
                    <AlertTriangle className="h-5 w-5 text-red-600 mt-0.5 flex-shrink-0" />
                    <div>
                      <p className="text-sm font-medium text-red-800 mb-2">
                        Unable to Load Trackers
                      </p>
                      <p className="text-sm text-red-700 mb-3">
                        {trackersError}
                      </p>
                      <div className="space-y-2">
                        <button
                          type="button"
                          onClick={loadAvailableTrackers}
                          className="text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700"
                        >
                          Try Again
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              ) : (
                <div>
                  <select
                    required
                    className="input"
                    value={formData.selected_tracker_id}
                    onChange={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        selected_tracker_id: (e.target as HTMLSelectElement)
                          .value,
                      }))
                    }
                  >
                    <option value="">Select a tracking device</option>
                    {availableTrackers
                      .filter((tracker) => tracker.isAvailable)
                      .map((tracker) => (
                        <option key={tracker.id} value={tracker.id}>
                          {tracker.name} (ID: {tracker.id}) - {tracker.status}
                        </option>
                      ))}
                  </select>

                  {/* Tracker Info */}
                  {selectedTracker && (
                    <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                      <div className="flex items-center space-x-2 mb-2">
                        <MapPin className="h-4 w-4 text-blue-600" />
                        <h4 className="font-medium text-blue-800">
                          Selected Tracker
                        </h4>
                      </div>
                      <div className="text-sm text-blue-700 space-y-1">
                        <p>
                          <strong>Device:</strong> {selectedTracker.name}
                        </p>
                        <p>
                          <strong>ID:</strong> {selectedTracker.id}
                        </p>
                        <p>
                          <strong>IMEI:</strong> {selectedTracker.sn}
                        </p>
                        <p>
                          <strong>Status:</strong> {selectedTracker.status}
                        </p>
                      </div>
                    </div>
                  )}

                  {/* Statistics */}
                  <div className="mt-3 text-xs text-gray-500 text-center">
                    {availableTrackers.filter((t) => t.isAvailable).length}{" "}
                    available â€¢{" "}
                    {availableTrackers.filter((t) => !t.isAvailable).length}{" "}
                    already assigned â€¢ {availableTrackers.length} total in
                    account
                  </div>
                </div>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700">
                Device Hash (Phone + Pi Combo) *
              </label>
              <div className="mt-1 flex space-x-2">
                <div className="flex-1 relative">
                  <input
                    type="text"
                    required
                    className="input pl-10 font-mono"
                    placeholder="Generated device hash"
                    value={formData.device_hash}
                    onInput={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        device_hash: (
                          e.target as HTMLInputElement
                        ).value.toUpperCase(),
                      }))
                    }
                  />
                  <Smartphone className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                </div>
                <button
                  type="button"
                  onClick={generateDeviceHash}
                  className="btn btn-secondary"
                >
                  Generate
                </button>
              </div>
            </div>

            <div className="bg-green-50 border border-green-200 rounded p-3 text-sm text-green-700">
              <p className="font-medium">âœ… Tracker Assignment Validated</p>
              <p className="mt-1">
                The selected tracker is confirmed available and will be assigned
                to this safe.
              </p>
            </div>

            <div className="flex justify-end space-x-3 pt-4 border-t">
              <button
                type="button"
                onClick={() => setCurrentStep(1)}
                className="btn btn-secondary"
                disabled={loading}
              >
                Back
              </button>
              <button
                type="submit"
                className="btn btn-primary"
                disabled={
                  !formData.selected_tracker_id ||
                  !formData.device_hash ||
                  !!trackersError
                }
              >
                Continue
              </button>
            </div>
          </form>
        )}

        {/* Step 3: Mobile User Setup */}
        {currentStep === 3 && (
          <form onSubmit={handleFinalSubmit} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700">
                Driver Name (Optional)
              </label>
              <div className="mt-1 relative">
                <input
                  type="text"
                  className="input pl-10"
                  placeholder="John Doe"
                  value={formData.driver_name}
                  onInput={(e) =>
                    setFormData((prev) => ({
                      ...prev,
                      driver_name: (e.target as HTMLInputElement).value,
                    }))
                  }
                />
                <User className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              </div>
              <p className="text-xs text-gray-500 mt-1">
                This will be used for the mobile app account
              </p>
            </div>

            {/* Summary */}
            <div className="bg-gray-50 rounded-lg p-4 space-y-3">
              <h4 className="font-medium text-gray-900">
                Registration Summary
              </h4>
              <div className="text-sm space-y-2">
                <div className="flex justify-between">
                  <span className="text-gray-500">Safe Serial:</span>
                  <span className="font-mono">{formData.serial_number}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-500">GPS Tracker:</span>
                  <span className="font-mono">
                    {selectedTracker?.name || formData.selected_tracker_id}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-500">Device Hash:</span>
                  <span className="font-mono text-xs">
                    {formData.device_hash}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-500">Driver:</span>
                  <span>{formData.driver_name || "Auto-generated"}</span>
                </div>
              </div>
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-700">
              <p className="font-medium">What will be created:</p>
              <ul className="mt-1 space-y-1 list-disc list-inside">
                <li>Safe registration with validated GPS tracker</li>
                <li>Mobile app user account for driver access</li>
                <li>Secure login credentials for the safe's phone</li>
                <li>Safe will be created as INACTIVE (ready for testing)</li>
              </ul>
            </div>

            <div className="flex justify-end space-x-3 pt-4 border-t">
              <button
                type="button"
                onClick={() => setCurrentStep(2)}
                className="btn btn-secondary"
                disabled={loading}
              >
                Back
              </button>
              <button
                type="submit"
                className="btn btn-primary"
                disabled={loading}
              >
                {loading ? (
                  <>
                    <LoadingSpinner size="small" className="mr-2" />
                    Creating Safe...
                  </>
                ) : (
                  "Create Safe & Mobile User"
                )}
              </button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/CreateTripModal.tsx">
import { useState, useEffect } from "preact/hooks";
import {
  X,
  Package,
  MapPin,
  Calendar,
  User,
  Phone,
  Mail,
  AlertTriangle,
  Copy,
  ExternalLink,
} from "lucide-preact";
import { dataService, type TripBookingData } from "../services/data";
import { LoadingSpinner } from "./LoadingSpinner";
import type { Safe } from "../types";

interface CreateTripModalProps {
  onClose: () => void;
  availableSafes: Safe[];
  editTrip?: any; // For editing existing trips
}

export function CreateTripModal({
  onClose,
  availableSafes,
  editTrip,
}: CreateTripModalProps) {
  const [currentStep, setCurrentStep] = useState(1);
  const [formData, setFormData] = useState<TripBookingData>({
    safe_id: editTrip?.safe_id || "",
    client_name: editTrip?.client_name || "",
    client_phone: editTrip?.client_phone || "",
    client_email: editTrip?.client_email || "",
    pickup_address: editTrip?.pickup_address || "",
    pickup_contact_name: editTrip?.pickup_contact_name || "",
    pickup_contact_phone: editTrip?.pickup_contact_phone || "",
    delivery_address: editTrip?.delivery_address || "",
    delivery_contact_name: editTrip?.delivery_contact_name || "",
    delivery_contact_phone: editTrip?.delivery_contact_phone || "",
    scheduled_pickup: editTrip?.scheduled_pickup || "",
    scheduled_delivery: editTrip?.scheduled_delivery || "",
    priority: editTrip?.priority || "normal",
    special_instructions: editTrip?.special_instructions || "",
    delivery_notes: editTrip?.delivery_notes || "",
    requires_signature: editTrip?.requires_signature || false,
    recurring: {
      enabled: false,
      frequency: "weekly",
      days_of_week: [],
    },
  });

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [warnings, setWarnings] = useState<string[]>([]);
  const [conflicts, setConflicts] = useState<any[]>([]);

  const steps = [
    { id: 1, title: "Basic Info", description: "Client and safe details" },
    { id: 2, title: "Addresses", description: "Pickup and delivery" },
    { id: 3, title: "Schedule", description: "Times and priority" },
  ];

  // Validate current step
  const validateStep = (step: number): boolean => {
    switch (step) {
      case 1:
        return !!(formData.safe_id && formData.client_name.trim());
      case 2:
        return !!(
          formData.pickup_address.trim() && formData.delivery_address.trim()
        );
      case 3:
        return !!(formData.scheduled_pickup && formData.scheduled_delivery);
      default:
        return true;
    }
  };

  // Check for conflicts when schedule changes
  useEffect(() => {
    if (
      formData.safe_id &&
      formData.scheduled_pickup &&
      formData.scheduled_delivery
    ) {
      checkConflicts();
    }
  }, [
    formData.safe_id,
    formData.scheduled_pickup,
    formData.scheduled_delivery,
  ]);

  const checkConflicts = async () => {
    try {
      const conflictList = await dataService.checkSchedulingConflicts(
        formData.safe_id,
        formData.scheduled_pickup,
        formData.scheduled_delivery,
        editTrip?.id
      );
      setConflicts(conflictList);
    } catch (error) {
      console.error("Error checking conflicts:", error);
    }
  };

  const handleSubmit = async () => {
    console.log("ðŸš€ Submit clicked - Current step:", currentStep);
    console.log("ðŸ“‹ Form data:", formData);

    setError("");
    setLoading(true);

    try {
      // Validate all data using the data service
      if (dataService.validateTripData) {
        console.log("âœ… Starting validation...");
        const validation = dataService.validateTripData(
          formData,
          availableSafes
        );

        console.log("ðŸ“Š Validation result:", validation);

        if (!validation.isValid) {
          setError(validation.errors.join(", "));
          setLoading(false);
          return;
        }

        setWarnings(validation.warnings);
      }

      console.log("ðŸ’¾ Calling createTrip...");
      let result;
      if (editTrip && dataService.updateTrip) {
        result = await dataService.updateTrip(editTrip.id, formData);
      } else {
        result = await dataService.createTrip(formData);
      }

      console.log("ðŸ“¥ Result:", result);

      if (result.success) {
        console.log("âœ… Trip created successfully!");
        onClose();
      } else {
        console.error("âŒ Trip creation failed:", result.error);
        setError(result.error || "Failed to save trip");
      }
    } catch (err) {
      console.error("ðŸ’¥ Exception:", err);
      setError("Network error. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  const setDefaultTimes = () => {
    const now = new Date();
    const pickup = new Date(now.getTime() + 2 * 60 * 60 * 1000);
    const delivery = new Date(now.getTime() + 4 * 60 * 60 * 1000);

    setFormData((prev) => ({
      ...prev,
      scheduled_pickup: pickup.toISOString().slice(0, 16),
      scheduled_delivery: delivery.toISOString().slice(0, 16),
    }));
  };

  const copyAddresses = () => {
    setFormData((prev) => ({
      ...prev,
      delivery_address: prev.pickup_address,
      delivery_contact_name: prev.pickup_contact_name,
      delivery_contact_phone: prev.pickup_contact_phone,
    }));
  };

  const renderStepContent = () => {
    switch (currentStep) {
      case 1:
        return (
          <div className="space-y-4">
            <h3 className="text-lg font-medium text-gray-900">
              Basic Information
            </h3>

            {/* Safe Selection */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Select Safe *
              </label>
              <div className="relative">
                <select
                  required
                  className="input pl-10"
                  value={formData.safe_id}
                  onChange={(e) =>
                    setFormData((prev) => ({
                      ...prev,
                      safe_id: (e.target as HTMLSelectElement).value,
                    }))
                  }
                >
                  <option value="">Choose a safe</option>
                  {availableSafes.map((safe) => (
                    <option key={safe.id} value={safe.id}>
                      Safe {safe.serial_number} (Battery: {safe.battery_level}%,
                      Status: {safe.status})
                    </option>
                  ))}
                </select>
                <Package className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              </div>
            </div>

            {/* Client Information */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Client Name *
                </label>
                <div className="relative">
                  <input
                    type="text"
                    required
                    className="input pl-10"
                    placeholder="Client full name"
                    value={formData.client_name}
                    onInput={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        client_name: (e.target as HTMLInputElement).value,
                      }))
                    }
                  />
                  <User className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Client Phone
                </label>
                <div className="relative">
                  <input
                    type="tel"
                    className="input pl-10"
                    placeholder="+1 (555) 123-4567"
                    value={formData.client_phone}
                    onInput={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        client_phone: (e.target as HTMLInputElement).value,
                      }))
                    }
                  />
                  <Phone className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                </div>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Client Email
              </label>
              <div className="relative">
                <input
                  type="email"
                  className="input pl-10"
                  placeholder="client@example.com"
                  value={formData.client_email}
                  onInput={(e) =>
                    setFormData((prev) => ({
                      ...prev,
                      client_email: (e.target as HTMLInputElement).value,
                    }))
                  }
                />
                <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              </div>
              <p className="text-xs text-gray-500 mt-1">
                Trip confirmation will be sent to this email address
              </p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Priority Level
              </label>
              <select
                className="input"
                value={formData.priority}
                onChange={(e) =>
                  setFormData((prev) => ({
                    ...prev,
                    priority: (e.target as HTMLSelectElement).value as any,
                  }))
                }
              >
                <option value="low">Low Priority</option>
                <option value="normal">Normal Priority</option>
                <option value="high">High Priority</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>
        );

      case 2:
        return (
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <h3 className="text-lg font-medium text-gray-900">
                Pickup & Delivery Addresses
              </h3>
              <button
                type="button"
                onClick={copyAddresses}
                className="text-sm text-blue-600 hover:text-blue-800 flex items-center space-x-1"
              >
                <Copy className="h-4 w-4" />
                <span>Copy pickup to delivery</span>
              </button>
            </div>
            {/* Pickup Address */}
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <h4 className="font-medium text-green-800 mb-3 flex items-center">
                <MapPin className="h-4 w-4 mr-2" />
                Pickup Location
              </h4>

              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Pickup Address *
                  </label>
                  <textarea
                    required
                    rows={2}
                    className="input"
                    placeholder="Enter full pickup address"
                    value={formData.pickup_address}
                    onInput={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        pickup_address: (e.target as HTMLTextAreaElement).value,
                      }))
                    }
                  />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Contact Name
                    </label>
                    <input
                      type="text"
                      className="input"
                      placeholder="Contact person"
                      value={formData.pickup_contact_name}
                      onInput={(e) =>
                        setFormData((prev) => ({
                          ...prev,
                          pickup_contact_name: (e.target as HTMLInputElement)
                            .value,
                        }))
                      }
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Contact Phone
                    </label>
                    <input
                      type="tel"
                      className="input"
                      placeholder="Contact number"
                      value={formData.pickup_contact_phone}
                      onInput={(e) =>
                        setFormData((prev) => ({
                          ...prev,
                          pickup_contact_phone: (e.target as HTMLInputElement)
                            .value,
                        }))
                      }
                    />
                  </div>
                </div>
              </div>
            </div>
            {/* Delivery Address */}
            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
              <h4 className="font-medium text-red-800 mb-3 flex items-center">
                <MapPin className="h-4 w-4 mr-2" />
                Delivery Location
              </h4>

              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Delivery Address *
                  </label>
                  <textarea
                    required
                    rows={2}
                    className="input"
                    placeholder="Enter full delivery address"
                    value={formData.delivery_address}
                    onInput={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        delivery_address: (e.target as HTMLTextAreaElement)
                          .value,
                      }))
                    }
                  />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Contact Name
                    </label>
                    <input
                      type="text"
                      className="input"
                      placeholder="Contact person"
                      value={formData.delivery_contact_name}
                      onInput={(e) =>
                        setFormData((prev) => ({
                          ...prev,
                          delivery_contact_name: (e.target as HTMLInputElement)
                            .value,
                        }))
                      }
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Contact Phone
                    </label>
                    <input
                      type="tel"
                      className="input"
                      placeholder="Contact number"
                      value={formData.delivery_contact_phone}
                      onInput={(e) =>
                        setFormData((prev) => ({
                          ...prev,
                          delivery_contact_phone: (e.target as HTMLInputElement)
                            .value,
                        }))
                      }
                    />
                  </div>
                </div>
              </div>
            </div>
            // After the delivery address section, add this:
            {/* Recipient Information */}
            <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
              <h4 className="font-medium text-purple-800 mb-3 flex items-center">
                <User className="h-4 w-4 mr-2" />
                Who Will Receive This Delivery?
              </h4>

              {/* Same as Client Toggle */}
              <div className="flex items-center space-x-3 mb-4">
                <input
                  type="checkbox"
                  id="recipient_is_client"
                  checked={formData.recipient_is_client ?? false}
                  onChange={(e) => {
                    const isClient = (e.target as HTMLInputElement).checked;
                    setFormData((prev) => ({
                      ...prev,
                      recipient_is_client: isClient,
                      // Auto-fill if same as client
                      recipient_name: isClient ? prev.client_name : "",
                      recipient_email: isClient ? prev.client_email : "",
                      recipient_phone: isClient ? prev.client_phone : "",
                    }));
                  }}
                />
                <label
                  htmlFor="recipient_is_client"
                  className="text-sm font-medium text-purple-800"
                >
                  Client is the recipient (receiving the delivery themselves)
                </label>
              </div>

              {/* Recipient Details (only show if NOT same as client) */}
              {!formData.recipient_is_client && (
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Recipient Name *
                    </label>
                    <input
                      type="text"
                      required={!formData.recipient_is_client}
                      className="input"
                      placeholder="Person receiving the delivery"
                      value={formData.recipient_name || ""}
                      onInput={(e) =>
                        setFormData((prev) => ({
                          ...prev,
                          recipient_name: (e.target as HTMLInputElement).value,
                        }))
                      }
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Recipient Email *
                      </label>
                      <input
                        type="email"
                        required={!formData.recipient_is_client}
                        className="input"
                        placeholder="For OTP delivery"
                        value={formData.recipient_email || ""}
                        onInput={(e) =>
                          setFormData((prev) => ({
                            ...prev,
                            recipient_email: (e.target as HTMLInputElement)
                              .value,
                          }))
                        }
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        OTP will be sent here
                      </p>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Recipient Phone
                      </label>
                      <input
                        type="tel"
                        className="input"
                        placeholder="Optional"
                        value={formData.recipient_phone || ""}
                        onInput={(e) =>
                          setFormData((prev) => ({
                            ...prev,
                            recipient_phone: (e.target as HTMLInputElement)
                              .value,
                          }))
                        }
                      />
                    </div>
                  </div>
                </div>
              )}

              {/* Info Box */}
              <div className="mt-3 bg-blue-50 border border-blue-200 rounded p-3 text-xs text-blue-700">
                <p className="font-medium mb-1">ðŸ“§ Email Flow:</p>
                <ul className="space-y-1">
                  <li>
                    â€¢{" "}
                    <strong>
                      Client ({formData.client_name || "Booking person"})
                    </strong>
                    : Gets booking confirmation + tracking link
                  </li>
                  <li>
                    â€¢{" "}
                    <strong>
                      Recipient (
                      {formData.recipient_is_client
                        ? "Same person"
                        : formData.recipient_name || "Receiving person"}
                      )
                    </strong>
                    : Gets arrival notification + OTP to unlock
                  </li>
                </ul>
              </div>
            </div>
            {/* Special Instructions */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Special Instructions
              </label>
              <textarea
                rows={3}
                className="input"
                placeholder="Any special handling or delivery instructions..."
                value={formData.special_instructions}
                onInput={(e) =>
                  setFormData((prev) => ({
                    ...prev,
                    special_instructions: (e.target as HTMLTextAreaElement)
                      .value,
                  }))
                }
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Delivery Notes
              </label>
              <textarea
                rows={2}
                className="input"
                placeholder="Additional notes for delivery..."
                value={formData.delivery_notes}
                onInput={(e) =>
                  setFormData((prev) => ({
                    ...prev,
                    delivery_notes: (e.target as HTMLTextAreaElement).value,
                  }))
                }
              />
            </div>
            {/* Signature Requirement */}
            <div className="flex items-center space-x-3">
              <input
                type="checkbox"
                id="signature"
                checked={formData.requires_signature}
                onChange={(e) =>
                  setFormData((prev) => ({
                    ...prev,
                    requires_signature: (e.target as HTMLInputElement).checked,
                  }))
                }
              />
              <label
                htmlFor="signature"
                className="text-sm font-medium text-gray-700"
              >
                Requires signature on delivery
              </label>
            </div>
          </div>
        );

      case 3:
        return (
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <h3 className="text-lg font-medium text-gray-900">
                Schedule & Review
              </h3>
              <button
                type="button"
                onClick={setDefaultTimes}
                className="text-sm text-blue-600 hover:text-blue-800"
              >
                Set default times
              </button>
            </div>

            {/* Schedule */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Pickup Time *
                </label>
                <div className="relative">
                  <input
                    type="datetime-local"
                    required
                    className="input pl-10"
                    value={formData.scheduled_pickup}
                    onInput={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        scheduled_pickup: (e.target as HTMLInputElement).value,
                      }))
                    }
                  />
                  <Calendar className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Delivery Time *
                </label>
                <div className="relative">
                  <input
                    type="datetime-local"
                    required
                    className="input pl-10"
                    value={formData.scheduled_delivery}
                    onInput={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        scheduled_delivery: (e.target as HTMLInputElement)
                          .value,
                      }))
                    }
                  />
                  <Calendar className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                </div>
              </div>
            </div>

            {/* Conflicts Warning */}
            {conflicts.length > 0 && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                <div className="flex items-center space-x-2 mb-2">
                  <AlertTriangle className="h-5 w-5 text-red-600" />
                  <h4 className="font-medium text-red-800">
                    Scheduling Conflicts
                  </h4>
                </div>
                {conflicts.map((conflict, index) => (
                  <p key={index} className="text-sm text-red-700">
                    Conflicts with trip for {conflict.client_name} on{" "}
                    {new Date(conflict.scheduled_pickup).toLocaleString()}
                  </p>
                ))}
              </div>
            )}

            {/* Recurring Options */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="flex items-center space-x-3 mb-3">
                <input
                  type="checkbox"
                  id="recurring"
                  checked={formData.recurring?.enabled}
                  onChange={(e) =>
                    setFormData((prev) => ({
                      ...prev,
                      recurring: {
                        ...prev.recurring!,
                        enabled: (e.target as HTMLInputElement).checked,
                      },
                    }))
                  }
                />
                <label
                  htmlFor="recurring"
                  className="font-medium text-blue-800"
                >
                  Make this a recurring trip (optional)
                </label>
              </div>

              {formData.recurring?.enabled && (
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Frequency
                    </label>
                    <select
                      className="input"
                      value={formData.recurring.frequency}
                      onChange={(e) =>
                        setFormData((prev) => ({
                          ...prev,
                          recurring: {
                            ...prev.recurring!,
                            frequency: (e.target as HTMLSelectElement)
                              .value as any,
                          },
                        }))
                      }
                    >
                      <option value="daily">Daily</option>
                      <option value="weekly">Weekly</option>
                      <option value="monthly">Monthly</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      End Date (optional)
                    </label>
                    <input
                      type="date"
                      className="input"
                      value={formData.recurring.end_date}
                      onChange={(e) =>
                        setFormData((prev) => ({
                          ...prev,
                          recurring: {
                            ...prev.recurring!,
                            end_date: (e.target as HTMLInputElement).value,
                          },
                        }))
                      }
                    />
                  </div>
                </div>
              )}
            </div>

            {/* Trip Summary */}
            <div className="bg-gray-50 rounded-lg p-4 space-y-3">
              <h4 className="font-medium text-gray-900">Trip Summary</h4>
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="font-medium text-gray-700">Client:</span>
                  <p>{formData.client_name}</p>
                  {formData.client_phone && (
                    <p className="text-gray-600">{formData.client_phone}</p>
                  )}
                </div>
                <div>
                  <span className="font-medium text-gray-700">Safe:</span>
                  <p>
                    {
                      availableSafes.find((s) => s.id === formData.safe_id)
                        ?.serial_number
                    }
                  </p>
                  <p className="text-gray-600">Priority: {formData.priority}</p>
                </div>
              </div>

              <div>
                <span className="font-medium text-gray-700">Pickup:</span>
                <p className="text-sm">{formData.pickup_address}</p>
                <p className="text-xs text-gray-600">
                  {formData.scheduled_pickup &&
                    new Date(formData.scheduled_pickup).toLocaleString()}
                </p>
              </div>

              <div>
                <span className="font-medium text-gray-700">Delivery:</span>
                <p className="text-sm">{formData.delivery_address}</p>
                <p className="text-xs text-gray-600">
                  {formData.scheduled_delivery &&
                    new Date(formData.scheduled_delivery).toLocaleString()}
                </p>
              </div>

              {formData.special_instructions && (
                <div>
                  <span className="font-medium text-gray-700">
                    Instructions:
                  </span>
                  <p className="text-sm">{formData.special_instructions}</p>
                </div>
              )}
            </div>

            {/* Customer Tracking Info */}
            {formData.client_email && (
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div className="flex items-center space-x-2 mb-2">
                  <ExternalLink className="h-4 w-4 text-blue-600" />
                  <h4 className="font-medium text-blue-800">
                    Customer Tracking
                  </h4>
                </div>
                <p className="text-sm text-blue-700 mb-2">
                  A secure tracking link will be automatically sent to:{" "}
                  <strong>{formData.client_email}</strong>
                </p>
                <p className="text-xs text-blue-600">
                  The customer will receive real-time updates on their secure
                  transport without accessing your dashboard.
                </p>
              </div>
            )}

            {/* Warnings */}
            {warnings.length > 0 && (
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div className="flex items-center space-x-2 mb-2">
                  <AlertTriangle className="h-4 w-4 text-yellow-600" />
                  <h4 className="font-medium text-yellow-800">Warnings</h4>
                </div>
                {warnings.map((warning, index) => (
                  <p key={index} className="text-sm text-yellow-700">
                    â€¢ {warning}
                  </p>
                ))}
              </div>
            )}
          </div>
        );

      default:
        return null;
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-bold text-gray-900">
            {editTrip ? "Edit Trip" : "Book New Trip"}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X className="h-6 w-6" />
          </button>
        </div>

        {/* Step Progress */}
        <div className="mb-8">
          <div className="flex items-center justify-between">
            {steps.map((step, index) => (
              <div key={step.id} className="flex items-center">
                <div
                  className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                    currentStep >= step.id
                      ? "bg-blue-600 text-white"
                      : "bg-gray-200 text-gray-600"
                  }`}
                >
                  {step.id}
                </div>
                <div className="ml-3 hidden sm:block">
                  <p
                    className={`text-sm font-medium ${
                      currentStep >= step.id ? "text-blue-600" : "text-gray-500"
                    }`}
                  >
                    {step.title}
                  </p>
                  <p className="text-xs text-gray-500">{step.description}</p>
                </div>
                {index < steps.length - 1 && (
                  <div
                    className={`w-12 h-0.5 mx-4 ${
                      currentStep > step.id ? "bg-blue-600" : "bg-gray-200"
                    }`}
                  />
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Error Display */}
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
            {error}
          </div>
        )}

        {/* Step Content */}
        <div className="mb-8">{renderStepContent()}</div>

        {/* Navigation */}
        <div className="flex justify-between pt-6 border-t">
          <button
            type="button"
            onClick={() => setCurrentStep(Math.max(1, currentStep - 1))}
            className="btn btn-secondary"
            disabled={currentStep === 1}
          >
            Previous
          </button>

          <div className="flex space-x-3">
            <button
              type="button"
              onClick={onClose}
              className="btn btn-secondary"
              disabled={loading}
            >
              Cancel
            </button>

            {currentStep < steps.length ? (
              <button
                type="button"
                onClick={() => setCurrentStep(currentStep + 1)}
                className="btn btn-primary"
                disabled={!validateStep(currentStep) || conflicts.length > 0}
              >
                Next
              </button>
            ) : (
              <button
                type="button"
                onClick={handleSubmit}
                className="btn btn-primary"
                disabled={loading || conflicts.length > 0}
              >
                {loading ? (
                  <>
                    <LoadingSpinner size="small" className="mr-2" />
                    {editTrip ? "Updating..." : "Booking..."}
                  </>
                ) : (
                  <>{editTrip ? "Update Trip" : "Book Trip"}</>
                )}
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/CreateUserModal.tsx">
import { useState } from "preact/hooks";
import { X, User, Mail, Key } from "lucide-preact";
import { authService } from "../services/auth";
import { currentUser } from "../store/auth";
import { LoadingSpinner } from "./LoadingSpinner";

interface CreateUserModalProps {
  onClose: () => void;
}

export function CreateUserModal({ onClose }: CreateUserModalProps) {
  const [formData, setFormData] = useState({
    email: "",
    username: "",
    password: "",
    role: "admin" as "admin",
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [showCredentials] = useState(false);
  const [createdUser] = useState<any>(null);

  const user = currentUser.value;

  const generatePassword = () => {
    const chars =
      "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*";
    let password = "";
    for (let i = 0; i < 12; i++) {
      password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    setFormData((prev) => ({ ...prev, password }));
  };

  const handleSubmit = async (e: Event) => {
    e.preventDefault();
    setError("");
    setLoading(true);

    try {
      const result = await authService.createUser({
        ...formData,
        created_by: user?.id,
      });

      if (result.success && result.user) {
        // Show success message instead of credentials screen
        alert(result.message || "User created successfully!");
        onClose();
      } else {
        setError(result.error || "Failed to create user");
      }
    } catch (err) {
      setError("Network error. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  const handleClose = () => {
    onClose();
  };

  if (showCredentials && createdUser) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-xl font-bold text-gray-900">
              User Created Successfully
            </h2>
            <button
              onClick={handleClose}
              className="text-gray-400 hover:text-gray-600"
            >
              <X className="h-6 w-6" />
            </button>
          </div>

          <div className="space-y-4">
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <div className="flex items-center space-x-2 mb-3">
                <div className="bg-green-500 rounded-full p-1">
                  <User className="h-4 w-4 text-white" />
                </div>
                <h3 className="font-medium text-green-800">Account Details</h3>
              </div>

              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-green-700">Email:</span>
                  <span className="font-mono text-green-900">
                    {formData.email}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-green-700">Username:</span>
                  <span className="font-mono text-green-900">
                    {formData.username}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-green-700">Password:</span>
                  <span className="font-mono text-green-900">
                    {formData.password}
                  </span>
                </div>
              </div>
            </div>

            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <p className="text-sm text-yellow-800">
                <strong>Important:</strong> Share these credentials securely
                with the user. They will be required to change their password on
                first login.
              </p>
            </div>

            <button onClick={handleClose} className="w-full btn btn-primary">
              Done
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-bold text-gray-900">Create New User</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X className="h-6 w-6" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm">
              {error}
            </div>
          )}

          <div>
            <label className="block text-sm font-medium text-gray-700">
              Email Address *
            </label>
            <div className="mt-1 relative">
              <input
                type="email"
                required
                className="input pl-10"
                placeholder="user@example.com"
                value={formData.email}
                onInput={(e) =>
                  setFormData((prev) => ({
                    ...prev,
                    email: (e.target as HTMLInputElement).value,
                  }))
                }
              />
              <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">
              Username *
            </label>
            <div className="mt-1 relative">
              <input
                type="text"
                required
                className="input pl-10"
                placeholder="Enter username"
                value={formData.username}
                onInput={(e) =>
                  setFormData((prev) => ({
                    ...prev,
                    username: (e.target as HTMLInputElement).value,
                  }))
                }
              />
              <User className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">
              Temporary Password *
            </label>
            <div className="mt-1 flex space-x-2">
              <div className="flex-1 relative">
                <input
                  type="text"
                  required
                  className="input pl-10"
                  placeholder="Generated password"
                  value={formData.password}
                  onInput={(e) =>
                    setFormData((prev) => ({
                      ...prev,
                      password: (e.target as HTMLInputElement).value,
                    }))
                  }
                />
                <Key className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              </div>
              <button
                type="button"
                onClick={generatePassword}
                className="btn btn-secondary"
              >
                Generate
              </button>
            </div>
          </div>

          <div className="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-700">
            <p className="font-medium">Note:</p>
            <p>
              The user will be required to change their password on first login.
            </p>
          </div>

          <div className="flex justify-end space-x-3 pt-4 border-t">
            <button
              type="button"
              onClick={onClose}
              className="btn btn-secondary"
              disabled={loading}
            >
              Cancel
            </button>
            <button
              type="submit"
              className="btn btn-primary"
              disabled={loading}
            >
              {loading ? (
                <>
                  <LoadingSpinner size="small" className="mr-2" />
                  Creating...
                </>
              ) : (
                "Create User"
              )}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="src/components/CustomerTrackingPage.tsx">
import { useState, useEffect, useRef } from "preact/hooks";
import {
  Shield,
  MapPin,
  Clock,
  Package,
  CheckCircle,
  AlertCircle,
  Navigation,
  RefreshCw,
} from "lucide-preact";
import { dataService } from "../services/data";
import { trackneticsService } from "../services/tracknetics";
import { LoadingSpinner } from "./LoadingSpinner";
import { format } from "date-fns";
import L from "leaflet";
import {
  fixLeafletIcons,
  createArrowIcon,
  getOpenStreetMapLayer,
} from "../utils/leafletHelpers";

interface CustomerTrackingPageProps {
  trackingToken: string;
}

interface TripTrackingData {
  id: string;
  client_name: string;
  pickup_address: string;
  delivery_address: string;
  status: string;
  scheduled_pickup: string;
  scheduled_delivery: string;
  actual_pickup_time?: string;
  actual_delivery_time?: string;
  priority?: string;
  special_instructions?: string;
  requires_signature?: boolean;
  created_at: string;
  updated_at: string;
  safes: {
    id: string;
    serial_number: string;
    status: string;
    battery_level: number;
    last_update: string;
    tracknetics_device_id?: string;
    tracking_device_id?: string;
  };
}

interface SafeLocationData {
  location?: {
    lat: number;
    lng: number;
    accuracy: number;
    timestamp: number;
    speed?: number;
  };
  status: "online" | "offline" | "no_tracker" | "error";
  error?: string;
  lastUpdate: Date;
}

export function CustomerTrackingPage({
  trackingToken,
}: CustomerTrackingPageProps) {
  const [trip, setTrip] = useState<TripTrackingData | null>(null);
  const [safeLocation, setSafeLocation] = useState<SafeLocationData>({
    status: "offline",
    lastUpdate: new Date(),
  });
  const [loading, setLoading] = useState(true);
  const [locationLoading, setLocationLoading] = useState(false);
  const [error, setError] = useState("");
  const [lastUpdate, setLastUpdate] = useState<Date>(new Date());
  const [autoRefresh] = useState(true);

  // Map refs
  const mapRef = useRef<HTMLDivElement>(null);
  const leafletMapRef = useRef<L.Map | null>(null);
  const safeMarkerRef = useRef<L.Marker | null>(null);
  const [mapsLoaded, setMapsLoaded] = useState(false);
  const [mapsError, setMapsError] = useState<string>("");

  // Load trip data
  const loadTripData = async (showLoading = true) => {
    if (showLoading) setLoading(true);
    setError("");

    try {
      const result = await dataService.getTripByTrackingToken(trackingToken);

      if (result.success && result.trip) {
        setTrip(result.trip as unknown as TripTrackingData);
        setLastUpdate(new Date());
      } else {
        setError(
          result.error || "Secure transport not found or tracking not enabled"
        );
      }
    } catch (err) {
      setError("Unable to load tracking information. Please try again.");
    } finally {
      if (showLoading) setLoading(false);
    }
  };

  // Initialize map
  const initializeMap = () => {
    if (!mapRef.current || leafletMapRef.current || mapsError) return;

    console.log("ðŸ—ºï¸ Initializing customer tracking map...");

    try {
      fixLeafletIcons();

      const map = L.map(mapRef.current, {
        center: [-26.2041, 28.0473], // Default to Johannesburg
        zoom: 13,
        zoomControl: true,
      });

      getOpenStreetMapLayer().addTo(map);

      leafletMapRef.current = map;
      setMapsLoaded(true);

      console.log("âœ… Customer tracking map initialized and ready");

      // If we already have location data, update marker immediately
      if (safeLocation.location) {
        console.log("ðŸ”„ Map ready, updating marker with existing location");
        updateSafeMarker();
      }
    } catch (error) {
      console.error("âŒ Error initializing customer map:", error);
      setMapsError("Failed to initialize map");
    }
  };

  // Update safe location
  const updateSafeLocation = async () => {
    if (!trip?.safes) return;

    const deviceId =
      trip.safes.tracknetics_device_id || trip.safes.tracking_device_id;
    if (!deviceId) {
      setSafeLocation({
        status: "no_tracker",
        error: "No tracking device available",
        lastUpdate: new Date(),
      });
      return;
    }

    setLocationLoading(true);

    try {
      console.log(
        `ðŸ“ Getting live location for customer tracking (device: ${deviceId})`
      );

      const result = await trackneticsService.getLocationByDeviceId(deviceId);

      if (result.success && result.location) {
        const newLocation: SafeLocationData = {
          location: result.location,
          status: "online",
          lastUpdate: new Date(),
        };
        setSafeLocation(newLocation);
        console.log(`âœ… Customer live location updated:`, result.location);
      } else {
        setSafeLocation({
          status: "offline",
          error: result.error || "No current location",
          lastUpdate: new Date(),
        });
      }
    } catch (error: any) {
      setSafeLocation({
        status: "error",
        error: error.message || "Failed to get location",
        lastUpdate: new Date(),
      });
    } finally {
      setLocationLoading(false);
    }
  };

  // Update safe marker on map
  const updateSafeMarker = () => {
    if (!leafletMapRef.current) {
      console.log("â³ Skipping marker update - map not available");
      return;
    }

    if (!safeLocation.location) {
      console.log("â³ Skipping marker update - no location data");
      return;
    }

    const position: L.LatLngExpression = [
      safeLocation.location.lat,
      safeLocation.location.lng,
    ];

    console.log("ðŸ“ Updating safe marker at:", position);

    try {
      if (!safeMarkerRef.current) {
        // Create safe marker
        const icon =
          safeLocation.location.speed && safeLocation.location.speed > 5
            ? createArrowIcon("#8B5CF6", 0)
            : L.divIcon({
                className: "custom-transport-marker",
                html: `<div style="
                background-color: #8B5CF6;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                border: 4px solid white;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
              "></div>`,
                iconSize: [28, 28],
                iconAnchor: [14, 14],
              });

        safeMarkerRef.current = L.marker(position, { icon }).addTo(
          leafletMapRef.current
        );

        // Safe info window
        const popupContent = `
          <div style="padding: 8px;">
            <h3 style="margin: 0 0 8px 0; color: #8B5CF6;">ðŸšš Your Secure Transport</h3>
            <div style="font-size: 12px;">
              <p style="margin: 2px 0;"><strong>Status:</strong> ${
                safeLocation.status
              }</p>
              <p style="margin: 2px 0;"><strong>Location:</strong> ${position[0].toFixed(
                6
              )}, ${position[1].toFixed(6)}</p>
              <p style="margin: 2px 0;"><strong>Accuracy:</strong> Â±${
                safeLocation.location.accuracy
              }m</p>
              ${
                safeLocation.location.speed
                  ? `<p style="margin: 2px 0;"><strong>Speed:</strong> ${safeLocation.location.speed} km/h</p>`
                  : ""
              }
              <p style="margin: 2px 0;"><strong>Last Update:</strong> Just now</p>
            </div>
          </div>
        `;

        safeMarkerRef.current.bindPopup(popupContent);

        // Center map on safe location
        leafletMapRef.current.setView(position, 15);
        console.log("âœ… Safe marker created and map centered");
      } else {
        // Update existing marker position
        safeMarkerRef.current.setLatLng(position);
        leafletMapRef.current.setView(
          position,
          leafletMapRef.current.getZoom()
        );
        console.log("âœ… Safe marker position updated");
      }
    } catch (error) {
      console.error("âŒ Error updating safe marker:", error);
    }
  };

  // Initialize everything
  useEffect(() => {
    loadTripData();
    initializeMap();

    return () => {
      if (leafletMapRef.current) {
        leafletMapRef.current.remove();
        leafletMapRef.current = null;
      }
    };
  }, [trackingToken]);

  // Update safe marker when location changes
  useEffect(() => {
    if (mapsLoaded && safeLocation.location && !mapsError) {
      updateSafeMarker();
    }
  }, [safeLocation, mapsLoaded, mapsError]);

  // Auto-refresh logic
  useEffect(() => {
    if (trip) {
      updateSafeLocation(); // Initial load

      if (autoRefresh && trip.status === "in_transit") {
        const interval = setInterval(() => {
          loadTripData(false); // Refresh trip data
          updateSafeLocation(); // Refresh location
        }, 30000);
        return () => clearInterval(interval);
      }
    }
  }, [trip, autoRefresh]);

  // Helper functions
  const getStatusInfo = (status: string) => {
    switch (status) {
      case "pending":
        return {
          color: "bg-blue-100 text-blue-800",
          icon: Clock,
          label: "Secure Transport Scheduled",
          description:
            "Your valuable items are scheduled for secure collection",
        };
      case "in_transit":
        return {
          color: "bg-yellow-100 text-yellow-800",
          icon: Package,
          label: "Secure Transport In Progress",
          description:
            "Your items are in secure transit with live GPS monitoring",
        };
      case "delivered":
        return {
          color: "bg-green-100 text-green-800",
          icon: CheckCircle,
          label: "Secure Delivery Complete",
          description: "Your items have been safely delivered",
        };
      case "cancelled":
        return {
          color: "bg-gray-100 text-gray-800",
          icon: AlertCircle,
          label: "Transport Cancelled",
          description: "This secure transport has been cancelled",
        };
      default:
        return {
          color: "bg-gray-100 text-gray-800",
          icon: Package,
          label: "Status Unknown",
          description: "",
        };
    }
  };

  const getPriorityLabel = (priority?: string) => {
    switch (priority) {
      case "urgent":
        return "URGENT";
      case "high":
        return "HIGH PRIORITY";
      default:
        return "STANDARD";
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 flex items-center justify-center px-4">
        <div className="text-center">
          <LoadingSpinner size="large" className="mb-4" />
          <p className="text-gray-300">
            Loading secure transport information...
          </p>
        </div>
      </div>
    );
  }

  if (error || !trip) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 flex items-center justify-center px-4">
        <div className="max-w-md w-full text-center">
          <div className="bg-red-100 rounded-full p-3 w-16 h-16 mx-auto mb-4">
            <AlertCircle className="h-10 w-10 text-red-600" />
          </div>
          <h2 className="text-xl font-bold text-white mb-2">
            Access Restricted
          </h2>
          <p className="text-gray-300 mb-6">{error}</p>
        </div>
      </div>
    );
  }

  const statusInfo = getStatusInfo(trip.status);
  const StatusIcon = statusInfo.icon;

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700">
      {/* Header */}
      <div className="bg-black/20 backdrop-blur-sm border-b border-gray-600">
        <div className="max-w-6xl mx-auto px-4 py-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <div className="bg-blue-600 rounded-lg p-3">
                <Shield className="h-8 w-8 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-white">Guardian Safe</h1>
                <p className="text-blue-200">Live Secure Transport Tracking</p>
              </div>
            </div>

            <div className="flex items-center space-x-3">
              <span className="text-xs text-gray-300">
                Updated {format(lastUpdate, "HH:mm:ss")}
              </span>
              {trip.status === "in_transit" && (
                <button
                  onClick={() => {
                    loadTripData(false);
                    updateSafeLocation();
                  }}
                  disabled={locationLoading}
                  className="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-sm transition-colors flex items-center space-x-1"
                >
                  <RefreshCw
                    className={`h-4 w-4 ${
                      locationLoading ? "animate-spin" : ""
                    }`}
                  />
                  <span>Refresh</span>
                </button>
              )}
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Trip Info Sidebar */}
          <div className="lg:col-span-1 space-y-6">
            {/* Status Card */}
            <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
              <div className="flex items-center space-x-4 mb-4">
                <div
                  className={`p-3 rounded-lg ${statusInfo.color
                    .replace("text-", "text-white bg-")
                    .replace("bg-blue-100", "bg-blue-600")
                    .replace("bg-yellow-100", "bg-yellow-600")
                    .replace("bg-green-100", "bg-green-600")
                    .replace("bg-gray-100", "bg-gray-600")}`}
                >
                  <StatusIcon className="h-6 w-6" />
                </div>
                <div>
                  <h2 className="text-xl font-bold text-white">
                    {statusInfo.label}
                  </h2>
                  <p className="text-gray-300">{statusInfo.description}</p>
                </div>
              </div>
              <div className="text-center">
                <span
                  className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusInfo.color}`}
                >
                  {trip.status.replace("_", " ").toUpperCase()}
                </span>
                <p className="text-xs text-gray-400 mt-2">
                  Priority: {getPriorityLabel(trip.priority)}
                </p>
              </div>
            </div>

            {/* Live Location Status */}
            {trip.status === "in_transit" && (
              <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-white flex items-center">
                    <Navigation className="h-5 w-5 mr-2" />
                    Live Location
                  </h3>
                  <div
                    className={`w-3 h-3 rounded-full ${
                      safeLocation.status === "online"
                        ? "bg-green-400 animate-pulse"
                        : "bg-red-400"
                    }`}
                  ></div>
                </div>

                {safeLocation.location ? (
                  <div className="space-y-2 text-sm text-gray-300">
                    <div className="flex justify-between">
                      <span>Status:</span>
                      <span className="text-green-400">
                        Live Tracking Active
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span>Coordinates:</span>
                      <span className="font-mono text-xs">
                        {safeLocation.location.lat.toFixed(4)},{" "}
                        {safeLocation.location.lng.toFixed(4)}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span>Accuracy:</span>
                      <span>Â±{safeLocation.location.accuracy}m</span>
                    </div>
                    {safeLocation.location.speed && (
                      <div className="flex justify-between">
                        <span>Speed:</span>
                        <span>{safeLocation.location.speed} km/h</span>
                      </div>
                    )}
                    <div className="flex justify-between">
                      <span>Last Update:</span>
                      <span>{format(safeLocation.lastUpdate, "HH:mm:ss")}</span>
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-4">
                    {locationLoading ? (
                      <div className="flex items-center justify-center space-x-2">
                        <LoadingSpinner size="small" />
                        <span className="text-gray-300">
                          Getting location...
                        </span>
                      </div>
                    ) : (
                      <p className="text-gray-400">
                        {safeLocation.error || "Location not available"}
                      </p>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* Addresses */}
            <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
              <h3 className="text-lg font-bold text-white mb-4">Locations</h3>
              <div className="space-y-4">
                <div>
                  <div className="flex items-center space-x-2 mb-2">
                    <div className="w-3 h-3 rounded-full bg-green-400"></div>
                    <p className="text-gray-300 font-medium">Pickup</p>
                  </div>
                  <p className="text-white text-sm ml-5">
                    {trip.pickup_address}
                  </p>
                </div>
                <div>
                  <div className="flex items-center space-x-2 mb-2">
                    <div className="w-3 h-3 rounded-full bg-red-400"></div>
                    <p className="text-gray-300 font-medium">Delivery</p>
                  </div>
                  <p className="text-white text-sm ml-5">
                    {trip.delivery_address}
                  </p>
                </div>
              </div>
            </div>

            {/* Schedule */}
            <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
              <h3 className="text-lg font-bold text-white mb-4 flex items-center">
                <Clock className="h-5 w-5 mr-2" />
                Schedule
              </h3>
              <div className="space-y-4">
                <div>
                  <p className="text-gray-300 font-medium">Pickup</p>
                  <p className="text-white">
                    {format(
                      new Date(trip.scheduled_pickup),
                      "MMM d, yyyy 'at' HH:mm"
                    )}
                  </p>
                  {trip.actual_pickup_time && (
                    <p className="text-green-400 text-sm">
                      âœ“ Completed{" "}
                      {format(
                        new Date(trip.actual_pickup_time),
                        "MMM d 'at' HH:mm"
                      )}
                    </p>
                  )}
                </div>
                <div>
                  <p className="text-gray-300 font-medium">Delivery</p>
                  <p className="text-white">
                    {format(
                      new Date(trip.scheduled_delivery),
                      "MMM d, yyyy 'at' HH:mm"
                    )}
                  </p>
                  {trip.actual_delivery_time && (
                    <p className="text-green-400 text-sm">
                      âœ“ Completed{" "}
                      {format(
                        new Date(trip.actual_delivery_time),
                        "MMM d 'at' HH:mm"
                      )}
                    </p>
                  )}
                </div>
              </div>
            </div>

            {/* Transport Details */}
            <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
              <h3 className="text-lg font-bold text-white mb-4">
                Transport Details
              </h3>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-400">Client:</span>
                  <span className="text-white">{trip.client_name}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-400">Transport ID:</span>
                  <span className="text-white font-mono">
                    {trip.id.slice(-8).toUpperCase()}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-400">Safe:</span>
                  <span className="text-white">{trip.safes.serial_number}</span>
                </div>
                {trip.requires_signature && (
                  <div className="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-3 mt-3">
                    <p className="text-yellow-300 text-sm">
                      âš ï¸ Signature required upon delivery
                    </p>
                  </div>
                )}
              </div>
            </div>

            {/* Special Instructions */}
            {trip.special_instructions && (
              <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                <h3 className="text-lg font-bold text-white mb-4">
                  Security Instructions
                </h3>
                <p className="text-gray-300">{trip.special_instructions}</p>
              </div>
            )}
          </div>

          {/* Map */}
          <div className="lg:col-span-2">
            <div className="bg-white/10 backdrop-blur-md rounded-xl border border-white/20 overflow-hidden">
              <div className="p-4 border-b border-white/20">
                <div className="flex items-center justify-between">
                  <h3 className="text-lg font-bold text-white">
                    Live GPS Position
                  </h3>
                  {trip.status === "in_transit" &&
                    safeLocation.location &&
                    !mapsError && (
                      <div className="flex items-center space-x-2">
                        <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span className="text-green-400 text-sm">Live</span>
                      </div>
                    )}
                </div>
              </div>

              <div className="h-96 relative">
                {/* Maps Error State */}
                {mapsError && (
                  <div className="absolute inset-0 flex items-center justify-center bg-gray-800">
                    <div className="text-center text-white">
                      <AlertCircle className="h-12 w-12 mx-auto mb-4 text-red-400" />
                      <p className="text-lg font-medium mb-2">Map Error</p>
                      <p className="text-gray-300 text-sm max-w-xs">
                        {mapsError}
                      </p>
                      <button
                        onClick={() => {
                          setMapsError("");
                          setMapsLoaded(false);
                          initializeMap();
                        }}
                        className="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors"
                      >
                        Retry
                      </button>
                    </div>
                  </div>
                )}

                {/* Map Container */}
                <div
                  ref={mapRef}
                  className="w-full h-full"
                  style={{
                    display: !mapsError ? "block" : "none",
                    minHeight: "384px",
                  }}
                />

                {/* No Location Message */}
                {mapsLoaded && !mapsError && !safeLocation.location && (
                  <div className="absolute inset-0 flex items-center justify-center bg-gray-800/50">
                    <div className="text-center text-white">
                      <MapPin className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                      <p className="text-lg font-medium mb-2">
                        Live Tracking Unavailable
                      </p>
                      <p className="text-gray-300 text-sm">
                        {trip.status === "pending"
                          ? "GPS tracking will activate when transport begins"
                          : safeLocation.error || "Location not available"}
                      </p>
                    </div>
                  </div>
                )}

                {/* Simple Legend */}
                {mapsLoaded && !mapsError && safeLocation.location && (
                  <div className="absolute bottom-4 right-4 bg-black/60 backdrop-blur-sm rounded-lg p-3 border border-white/20">
                    <div className="flex items-center space-x-2 text-sm">
                      <div className="w-4 h-4 rounded-full bg-purple-400"></div>
                      <span className="text-white">Your Transport</span>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="text-center text-gray-400 text-sm mt-8">
          <p className="mb-2">
            Last updated: {format(lastUpdate, "MMM d, yyyy 'at' HH:mm:ss")}
          </p>
          <p>Guardian Safe Security Services - Premium Secure Transport</p>
          {autoRefresh && trip.status === "in_transit" && (
            <p className="text-xs mt-2 text-gray-500">
              ðŸ”„ Auto-updating every 30 seconds
            </p>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/DashboardLayout.tsx">
import { LogOut, User, Shield } from "lucide-preact";
import { authService } from "../services/auth";
import { currentUser } from "../store/auth";

interface DashboardLayoutProps {
  title: string;
  children: preact.ComponentChildren;
  actions?: preact.ComponentChildren;
}

export function DashboardLayout({
  title,
  children,
  actions,
}: DashboardLayoutProps) {
  const user = currentUser.value;

  const handleLogout = async () => {
    await authService.logout();
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-6">
            <div className="flex items-center space-x-4">
              <div className="bg-blue-600 rounded-lg p-2">
                <Shield className="h-8 w-8 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">{title}</h1>
                <p className="text-sm text-gray-500 capitalize">
                  {user?.role} Dashboard
                </p>
              </div>
            </div>

            <div className="flex items-center space-x-4">
              {actions}

              <div className="flex items-center space-x-3">
                <div className="bg-gray-100 rounded-full p-2">
                  <User className="h-5 w-5 text-gray-600" />
                </div>
                <div>
                  <p className="text-sm font-medium text-gray-900">
                    {user?.username}
                  </p>
                  <p className="text-xs text-gray-500 capitalize">
                    {user?.role}
                  </p>
                </div>
              </div>

              <button
                onClick={handleLogout}
                className="btn btn-secondary"
                title="Sign Out"
              >
                <LogOut className="h-4 w-4" />
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="src/components/LiveTracking.tsx">
import { useState, useEffect, useRef } from "preact/hooks";
import {
  MapPin,
  Navigation,
  RefreshCw,
  Satellite,
  AlertTriangle,
  Battery,
} from "lucide-preact";
import { LoadingSpinner } from "./LoadingSpinner";
import { trackneticsService } from "../services/tracknetics";
import type { Safe } from "../types";
import { formatDistanceToNow } from "date-fns";
import L from "leaflet";
import {
  fixLeafletIcons,
  createArrowIcon,
  getOpenStreetMapLayer,
  getSatelliteLayer,
} from "../utils/leafletHelpers";

interface LiveTrackingProps {
  safes: Safe[];
}

interface SafeLocationData {
  safeId: string;
  serialNumber: string;
  deviceId: string | null;
  location?: {
    lat: number;
    lng: number;
    accuracy: number;
    timestamp: number;
    speed?: number;
    course?: number;
    isGPS?: boolean;
    positionTime?: string;
  };
  status: "online" | "offline" | "no_tracker" | "error";
  error?: string;
  lastUpdate: Date;
}

export function LiveTracking({ safes }: LiveTrackingProps) {
  const [locations, setLocations] = useState<SafeLocationData[]>([]);
  const [loading, setLoading] = useState(false);
  const [lastUpdate, setLastUpdate] = useState<Date | null>(null);
  const [mapView, setMapView] = useState<"roadmap" | "satellite">("roadmap");
  const [autoRefresh, setAutoRefresh] = useState(true);
  const mapRef = useRef<HTMLDivElement>(null);
  const leafletMapRef = useRef<L.Map | null>(null);
  const markersRef = useRef<L.Marker[]>([]);
  const [mapsLoaded, setMapsLoaded] = useState(false);

  // Initialize Leaflet map
  const initializeMap = () => {
    if (!mapRef.current || leafletMapRef.current) return;

    console.log("ðŸ—ºï¸ Initializing Leaflet Map...");

    try {
      // Fix Leaflet icons
      fixLeafletIcons();

      // Create map centered on Johannesburg
      const map = L.map(mapRef.current, {
        center: [-26.2041, 28.0473],
        zoom: 8,
        zoomControl: true,
      });

      // Add tile layer based on view type
      if (mapView === "satellite") {
        getSatelliteLayer().addTo(map);
      } else {
        getOpenStreetMapLayer().addTo(map);
      }

      leafletMapRef.current = map;
      setMapsLoaded(true);

      console.log("âœ… Leaflet Map initialized successfully");
    } catch (error) {
      console.error("âŒ Error initializing Leaflet Map:", error);
    }
  };

  // Update map markers
  const updateMapMarkers = () => {
    if (!leafletMapRef.current || !mapsLoaded) {
      console.log("â³ Map not ready for marker updates");
      return;
    }

    console.log("ðŸ·ï¸ Updating map markers...");

    try {
      // Clear existing markers
      markersRef.current.forEach((marker) => marker.remove());
      markersRef.current = [];

      const bounds: L.LatLngBoundsExpression = [];
      let hasValidLocations = false;

      // Create new markers
      for (const safeLocation of locations) {
        if (!safeLocation.location) continue;

        const position: L.LatLngExpression = [
          safeLocation.location.lat,
          safeLocation.location.lng,
        ];

        // Choose icon based on status and movement
        const color = safeLocation.status === "online" ? "#10B981" : "#EF4444";
        const icon =
          safeLocation.location.speed && safeLocation.location.speed > 5
            ? createArrowIcon(color, safeLocation.location.course || 0)
            : L.divIcon({
                className: "custom-marker",
                html: `<div style="
                background-color: ${color};
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
              "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
              });

        const marker = L.marker(position, { icon }).addTo(
          leafletMapRef.current!
        );

        // Create popup
        const popupContent = `
          <div style="padding: 8px; min-width: 200px;">
            <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">
              Safe ${safeLocation.serialNumber}
            </h3>
            <div style="font-size: 14px; line-height: 1.4;">
              <p style="margin: 4px 0;"><strong>Status:</strong> ${getStatusLabel(
                safeLocation.status
              )}</p>
              <p style="margin: 4px 0;"><strong>Location:</strong> ${position[0].toFixed(
                6
              )}, ${position[1].toFixed(6)}</p>
              <p style="margin: 4px 0;"><strong>Accuracy:</strong> Â±${
                safeLocation.location.accuracy
              }m</p>
              <p style="margin: 4px 0;"><strong>Updated:</strong> ${formatDistanceToNow(
                safeLocation.lastUpdate
              )} ago</p>
              ${
                safeLocation.location.speed
                  ? `<p style="margin: 4px 0;"><strong>Speed:</strong> ${safeLocation.location.speed} km/h</p>`
                  : ""
              }
            </div>
          </div>
        `;

        marker.bindPopup(popupContent);
        markersRef.current.push(marker);
        bounds.push(position);
        hasValidLocations = true;
      }

      // Fit bounds to show all markers
      if (hasValidLocations && bounds.length > 0) {
        leafletMapRef.current.fitBounds(bounds, { padding: [50, 50] });
      }

      console.log(`âœ… Updated ${markersRef.current.length} markers on map`);
    } catch (error) {
      console.error("âŒ Error updating markers:", error);
    }
  };

  // Switch map layer when view changes
  useEffect(() => {
    if (leafletMapRef.current) {
      // Remove all tile layers
      leafletMapRef.current.eachLayer((layer) => {
        if (layer instanceof L.TileLayer) {
          leafletMapRef.current!.removeLayer(layer);
        }
      });

      // Add new tile layer
      if (mapView === "satellite") {
        getSatelliteLayer().addTo(leafletMapRef.current);
      } else {
        getOpenStreetMapLayer().addTo(leafletMapRef.current);
      }
    }
  }, [mapView]);

  // Initialize map on mount
  useEffect(() => {
    initializeMap();

    return () => {
      if (leafletMapRef.current) {
        leafletMapRef.current.remove();
        leafletMapRef.current = null;
      }
    };
  }, []);

  // Update markers when locations change
  useEffect(() => {
    if (mapsLoaded) {
      updateMapMarkers();
    }
  }, [locations, mapsLoaded]);

  // Get trackable safes
  const trackableSafes = safes.filter(
    (safe) => safe.tracknetics_device_id || safe.tracking_device_id
  );

  const updateLocations = async () => {
    if (trackableSafes.length === 0) return;

    setLoading(true);
    const newLocations: SafeLocationData[] = [];

    console.log(
      "ðŸ—ºï¸ Updating locations for",
      trackableSafes.length,
      "trackable safes"
    );

    for (const safe of trackableSafes) {
      const deviceId = safe.tracknetics_device_id || safe.tracking_device_id;

      const safeLocation: SafeLocationData = {
        safeId: safe.id,
        serialNumber: safe.serial_number,
        deviceId: deviceId || null,
        status: "offline",
        lastUpdate: new Date(),
      };

      if (deviceId) {
        try {
          console.log(
            `ðŸ“ Getting location for safe ${safe.serial_number} (device: ${deviceId})`
          );

          const result = await trackneticsService.getLocationByDeviceId(
            deviceId
          );

          if (result.success && result.location) {
            safeLocation.location = {
              lat: result.location.lat,
              lng: result.location.lng,
              accuracy: result.location.accuracy,
              timestamp: result.location.timestamp,
            };
            safeLocation.status = "online";
            console.log(
              `âœ… Location found for ${safe.serial_number}:`,
              result.location
            );
          } else {
            safeLocation.status = "offline";
            safeLocation.error = result.error || "No location data";
            console.log(
              `âŒ No location for ${safe.serial_number}:`,
              result.error
            );
          }
        } catch (error: any) {
          safeLocation.status = "error";
          safeLocation.error = error.message || "Failed to get location";
          console.error(
            `ðŸ’¥ Error getting location for ${safe.serial_number}:`,
            error
          );
        }
      } else {
        safeLocation.status = "no_tracker";
        safeLocation.error = "No tracking device assigned";
      }

      newLocations.push(safeLocation);
    }

    setLocations(newLocations);
    setLastUpdate(new Date());
    setLoading(false);

    console.log("ðŸ—ºï¸ Location update complete:", newLocations);
  };

  // Auto-refresh every 30 seconds
  useEffect(() => {
    updateLocations();

    if (autoRefresh) {
      const interval = setInterval(updateLocations, 30000);
      return () => clearInterval(interval);
    }
  }, [safes, autoRefresh]);

  const getStatusColor = (status: SafeLocationData["status"]) => {
    switch (status) {
      case "online":
        return "text-green-600 bg-green-100";
      case "offline":
        return "text-red-600 bg-red-100";
      case "no_tracker":
        return "text-gray-600 bg-gray-100";
      case "error":
        return "text-orange-600 bg-orange-100";
      default:
        return "text-gray-600 bg-gray-100";
    }
  };

  const getStatusLabel = (status: SafeLocationData["status"]) => {
    switch (status) {
      case "online":
        return "Online";
      case "offline":
        return "Offline";
      case "no_tracker":
        return "No Tracker";
      case "error":
        return "Error";
      default:
        return "Unknown";
    }
  };

  if (trackableSafes.length === 0) {
    return (
      <div className="card text-center py-12">
        <MapPin className="h-12 w-12 text-gray-400 mx-auto mb-4" />
        <h3 className="text-lg font-medium text-gray-900 mb-2">
          No Trackable Safes
        </h3>
        <p className="text-gray-500 mb-4">
          No safes have tracking devices assigned.
        </p>
        <p className="text-sm text-gray-400">
          Add a tracking device ID to safes in the database to enable live
          tracking.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Controls */}
      <div className="card">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="text-lg font-medium text-gray-900">
              Live GPS Tracking
            </h3>
            <p className="text-sm text-gray-500">
              {lastUpdate && `Last updated: ${lastUpdate.toLocaleTimeString()}`}
            </p>
          </div>

          <div className="flex items-center space-x-3">
            {/* Auto-refresh toggle */}
            <label className="flex items-center space-x-2 text-sm">
              <input
                type="checkbox"
                checked={autoRefresh}
                onChange={(e) =>
                  setAutoRefresh((e.target as HTMLInputElement).checked)
                }
                className="rounded"
              />
              <span>Auto-refresh</span>
            </label>

            {/* Map view toggle */}
            <div className="flex rounded-lg border border-gray-300">
              <button
                onClick={() => setMapView("roadmap")}
                className={`px-3 py-1 text-sm rounded-l-lg ${
                  mapView === "roadmap"
                    ? "bg-blue-600 text-white"
                    : "bg-white text-gray-700 hover:bg-gray-50"
                }`}
              >
                <Navigation className="h-4 w-4" />
              </button>
              <button
                onClick={() => setMapView("satellite")}
                className={`px-3 py-1 text-sm rounded-r-lg ${
                  mapView === "satellite"
                    ? "bg-blue-600 text-white"
                    : "bg-white text-gray-700 hover:bg-gray-50"
                }`}
              >
                <Satellite className="h-4 w-4" />
              </button>
            </div>

            {/* Manual refresh */}
            <button
              onClick={updateLocations}
              disabled={loading}
              className="btn btn-secondary"
            >
              {loading ? (
                <LoadingSpinner size="small" className="mr-2" />
              ) : (
                <RefreshCw className="h-4 w-4 mr-2" />
              )}
              Refresh
            </button>
          </div>
        </div>
      </div>

      {/* Leaflet Map */}
      <div className="card">
        <div className="h-96 rounded-lg overflow-hidden bg-gray-200">
          {!mapsLoaded && (
            <div className="w-full h-full flex items-center justify-center">
              <div className="text-center">
                <LoadingSpinner size="large" />
                <p className="mt-4 text-gray-600">Loading map...</p>
              </div>
            </div>
          )}
          <div
            ref={mapRef}
            className="w-full h-full"
            style={{ minHeight: "384px" }}
          />
        </div>

        {/* Map Legend */}
        <div className="mt-4 flex items-center justify-between">
          <div className="flex items-center space-x-4 text-sm">
            <div className="flex items-center space-x-2">
              <div className="w-3 h-3 rounded-full bg-green-500"></div>
              <span>Online</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="w-3 h-3 rounded-full bg-red-500"></div>
              <span>Offline</span>
            </div>
          </div>

          <div className="text-xs text-gray-500">
            Click markers for details â€¢{" "}
            {locations.filter((l) => l.location).length} of {locations.length}{" "}
            safes located
          </div>
        </div>
      </div>

      {/* Location Status Cards - keeping your existing cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {locations.map((safeLocation) => {
          const safe = safes.find((s) => s.id === safeLocation.safeId);

          return (
            <div key={safeLocation.safeId} className="card">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center space-x-3">
                  <div
                    className={`p-2 rounded-lg ${
                      safeLocation.status === "online"
                        ? "bg-green-100"
                        : "bg-gray-100"
                    }`}
                  >
                    <MapPin
                      className={`h-5 w-5 ${
                        safeLocation.status === "online"
                          ? "text-green-600"
                          : "text-gray-400"
                      }`}
                    />
                  </div>
                  <div>
                    <h4 className="font-medium text-gray-900">
                      Safe {safeLocation.serialNumber}
                    </h4>
                    <p className="text-sm text-gray-500">
                      Device: {safeLocation.deviceId || "None"}
                    </p>
                  </div>
                </div>

                <span
                  className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(
                    safeLocation.status
                  )}`}
                >
                  {getStatusLabel(safeLocation.status)}
                </span>
              </div>

              {safeLocation.location ? (
                <div className="space-y-3">
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <p className="text-gray-500">Latitude</p>
                      <p className="font-mono text-gray-900">
                        {safeLocation.location.lat.toFixed(6)}
                      </p>
                    </div>
                    <div>
                      <p className="text-gray-500">Longitude</p>
                      <p className="font-mono text-gray-900">
                        {safeLocation.location.lng.toFixed(6)}
                      </p>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <p className="text-gray-500">Accuracy</p>
                      <p className="text-gray-900">
                        Â±{safeLocation.location.accuracy}m
                        {safeLocation.location.isGPS && (
                          <span className="ml-1 text-green-600 text-xs">
                            GPS
                          </span>
                        )}
                      </p>
                    </div>
                    <div>
                      <p className="text-gray-500">Updated</p>
                      <p className="text-gray-900 text-xs">
                        {formatDistanceToNow(safeLocation.lastUpdate)} ago
                      </p>
                    </div>
                  </div>

                  {/* Safe Status Integration */}
                  {safe && (
                    <div className="pt-3 border-t border-gray-200">
                      <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center space-x-4">
                          <div className="flex items-center space-x-1">
                            <Battery className="h-3 w-3 text-gray-400" />
                            <span
                              className={`text-xs ${
                                safe.battery_level > 50
                                  ? "text-green-600"
                                  : safe.battery_level > 20
                                  ? "text-yellow-600"
                                  : "text-red-600"
                              }`}
                            >
                              {safe.battery_level}%
                            </span>
                          </div>
                          <div className="flex items-center space-x-1">
                            <div
                              className={`w-2 h-2 rounded-full ${
                                safe.status === "active"
                                  ? "bg-green-500"
                                  : "bg-gray-400"
                              }`}
                            />
                            <span className="text-xs text-gray-600 capitalize">
                              {safe.status}
                            </span>
                          </div>
                        </div>

                        <button
                          onClick={() =>
                            window.open(
                              `https://www.openstreetmap.org/?mlat=${safeLocation.location?.lat}&mlon=${safeLocation.location?.lng}#map=15/${safeLocation.location?.lat}/${safeLocation.location?.lng}`,
                              "_blank"
                            )
                          }
                          className="text-blue-600 hover:text-blue-800 text-xs"
                        >
                          View on OSM
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <div className="text-center py-4">
                  <AlertTriangle className="h-8 w-8 text-gray-400 mx-auto mb-2" />
                  <p className="text-gray-500 text-sm">
                    {safeLocation.error || "No location data available"}
                  </p>
                  {safeLocation.status === "no_tracker" && (
                    <p className="text-xs text-gray-400 mt-1">
                      Add tracking device ID to database
                    </p>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* System Status */}
      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h4 className="font-medium text-blue-800 mb-2">System Status:</h4>
        <ul className="text-sm text-blue-700 space-y-1">
          <li>âœ… Tracknetics API: Connected and operational</li>
          <li>
            âœ… OpenStreetMap:{" "}
            {mapsLoaded ? "Loaded successfully" : "Loading..."}
          </li>
          <li>
            âœ… Real-time tracking:{" "}
            {autoRefresh ? "Active (30s intervals)" : "Manual only"}
          </li>
          <li>âœ… Open source mapping with Leaflet</li>
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="src/components/LoadingSpinner.tsx">
import { clsx } from "clsx";

interface LoadingSpinnerProps {
  size?: "small" | "medium" | "large";
  className?: string;
}

export function LoadingSpinner({
  size = "medium",
  className,
}: LoadingSpinnerProps) {
  const sizeClasses = {
    small: "w-4 h-4",
    medium: "w-6 h-6",
    large: "w-8 h-8",
  };

  return (
    <div
      className={clsx(
        "animate-spin rounded-full border-2 border-gray-300 border-t-blue-600",
        sizeClasses[size],
        className
      )}
    />
  );
}
</file>

<file path="src/components/LoginPage.tsx">
import { useState } from "preact/hooks";
import { Shield, Eye, EyeOff } from "lucide-preact";
import { authService } from "../services/auth";
import { LoadingSpinner } from "./LoadingSpinner";

export function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const handleLogin = async (e: Event) => {
    e.preventDefault();
    setError("");
    setLoading(true);

    try {
      const result = await authService.login(email, password);

      if (!result.success) {
        setError(result.error || "Login failed");
      }
      // Success is handled by auth state change
    } catch (err) {
      setError("Network error. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-900 to-blue-700 flex items-center justify-center px-4">
      <div className="max-w-md w-full space-y-8">
        {/* Header */}
        <div className="text-center">
          <div className="flex justify-center">
            <div className="bg-white rounded-full p-3">
              <Shield className="h-12 w-12 text-blue-600" />
            </div>
          </div>
          <h2 className="mt-6 text-3xl font-extrabold text-white">
            Guardian Safe
          </h2>
          <p className="mt-2 text-sm text-blue-100">
            Secure Delivery Management System
          </p>
        </div>

        {/* Login Form */}
        <div className="bg-white rounded-xl shadow-xl p-8">
          <form className="space-y-6" onSubmit={handleLogin}>
            {error && (
              <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm">
                {error}
              </div>
            )}

            <div>
              <label
                htmlFor="email"
                className="block text-sm font-medium text-gray-700"
              >
                Email Address
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                className="mt-1 input"
                placeholder="Enter your email"
                value={email}
                onInput={(e) => setEmail((e.target as HTMLInputElement).value)}
              />
            </div>

            <div>
              <label
                htmlFor="password"
                className="block text-sm font-medium text-gray-700"
              >
                Password
              </label>
              <div className="mt-1 relative">
                <input
                  id="password"
                  name="password"
                  type={showPassword ? "text" : "password"}
                  autoComplete="current-password"
                  required
                  className="input pr-10"
                  placeholder="Enter your password"
                  value={password}
                  onInput={(e) =>
                    setPassword((e.target as HTMLInputElement).value)
                  }
                />
                <button
                  type="button"
                  className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                  onClick={() => setShowPassword(!showPassword)}
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full btn btn-primary py-3 text-base font-medium"
            >
              {loading ? (
                <>
                  <LoadingSpinner size="small" className="mr-2" />
                  Signing in...
                </>
              ) : (
                "Sign In"
              )}
            </button>
          </form>

          <div className="mt-6 text-center">
            <p className="text-xs text-gray-500">
              Contact your administrator for account access or password reset.
            </p>
          </div>
        </div>

        <div className="text-center text-blue-100 text-sm">
          Â© 2024 Guardian Safe System. All rights reserved.
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/OwnerDashboard.tsx">
import { useState } from "preact/hooks";
import { Plus, Users, Shield, Package } from "lucide-preact";
import { DashboardLayout } from "./DashboardLayout";
import { CreateUserModal } from "./CreateUserModal";
import { CreateSafeModal } from "./CreateSafeModal";
import { UsersList } from "./UsersList";
import { SafesList } from "./SafesList";
import { TripsList } from "./TripsList";
import { StatsCards } from "./StatsCards";
import { safes, trips } from "../store/data";

export function OwnerDashboard() {
  const [showCreateUser, setShowCreateUser] = useState(false);
  const [showCreateSafe, setShowCreateSafe] = useState(false);
  const [activeTab, setActiveTab] = useState<
    "overview" | "users" | "safes" | "trips" | "security"
  >("overview");

  const safesList = safes.value;
  const tripsList = trips.value;

  const stats = {
    totalSafes: safesList.length,
    activeSafes: safesList.filter((s) => s.status === "active").length,
    totalTrips: tripsList.length,
    activeTrips: tripsList.filter((t) => t.status === "in_transit").length,
  };

  const actions = (
    <div className="flex space-x-3">
      <button
        onClick={() => setShowCreateUser(true)}
        className="btn btn-secondary"
      >
        <Users className="h-4 w-4 mr-2" />
        Add User
      </button>
      <button
        onClick={() => setShowCreateSafe(true)}
        className="btn btn-primary"
      >
        <Plus className="h-4 w-4 mr-2" />
        Register Safe
      </button>
    </div>
  );

  const tabs = [
    { id: "overview", label: "Overview", icon: Package },
    { id: "users", label: "Users", icon: Users },
    { id: "safes", label: "Safes", icon: Shield },
    { id: "trips", label: "Trips", icon: Package },
  ];

  return (
    <>
      <DashboardLayout title="Guardian Safe" actions={actions}>
        <div className="bg-white rounded-lg shadow mb-6">
          <div className="border-b border-gray-200">
            <nav className="-mb-px flex space-x-8 px-6">
              {tabs.map((tab) => {
                const IconComponent = tab.icon;
                return (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id as any)}
                    className={`py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2 ${
                      activeTab === tab.id
                        ? "border-blue-500 text-blue-600"
                        : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                    }`}
                  >
                    <IconComponent className="h-4 w-4" />
                    <span>{tab.label}</span>
                  </button>
                );
              })}
            </nav>
          </div>
        </div>

        {activeTab === "overview" && (
          <div className="space-y-6">
            <StatsCards stats={stats} />

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="card">
                <h3 className="text-lg font-medium text-gray-900 mb-4">
                  Recent Safes
                </h3>
                <SafesList limit={5} showActions={false} />
              </div>

              <div className="card">
                <h3 className="text-lg font-medium text-gray-900 mb-4">
                  Recent Trips
                </h3>
                <TripsList limit={5} showActions={false} />
              </div>
            </div>
          </div>
        )}

        {activeTab === "users" && <UsersList />}
        {activeTab === "safes" && <SafesList />}
        {activeTab === "trips" && <TripsList />}
      </DashboardLayout>

      {showCreateUser && (
        <CreateUserModal onClose={() => setShowCreateUser(false)} />
      )}
      {showCreateSafe && (
        <CreateSafeModal onClose={() => setShowCreateSafe(false)} />
      )}
    </>
  );
}
</file>

<file path="src/components/SafesList.tsx">
import { useState } from "preact/hooks";
import { Shield, Battery, Lock, Unlock, MapPin, Activity } from "lucide-preact";
import { safes } from "../store/data";
import { currentUser, isOwner } from "../store/auth";
import { dataService } from "../services/data";
import { LoadingSpinner } from "./LoadingSpinner";
import { formatDistanceToNow } from "date-fns";

interface SafesListProps {
  limit?: number;
  showActions?: boolean;
}

export function SafesList({ limit, showActions = true }: SafesListProps) {
  const [updatingStatus, setUpdatingStatus] = useState<string | null>(null);

  const user = currentUser.value;
  const isOwnerRole = isOwner.value;

  let safesList = safes.value;

  // Filter safes based on user role
  if (!isOwnerRole && user) {
    safesList = safesList.filter((safe) => safe.assigned_to === user.id);
  }

  // Apply limit if specified
  if (limit) {
    safesList = safesList.slice(0, limit);
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case "active":
        return "text-green-600 bg-green-100";
      case "inactive":
        return "text-gray-600 bg-gray-100";
      case "maintenance":
        return "text-yellow-600 bg-yellow-100";
      case "offline":
        return "text-red-600 bg-red-100";
      default:
        return "text-gray-600 bg-gray-100";
    }
  };

  const getBatteryColor = (level: number) => {
    if (level > 50) return "text-green-600";
    if (level > 20) return "text-yellow-600";
    return "text-red-600";
  };

  const handleStatusChange = async (safeId: string, newStatus: string) => {
    if (!isOwnerRole) return;

    setUpdatingStatus(safeId);
    try {
      await dataService.updateSafeStatus(safeId, { status: newStatus as any });
    } catch (error) {
      console.error("Failed to update safe status:", error);
    } finally {
      setUpdatingStatus(null);
    }
  };

  if (safesList.length === 0) {
    return (
      <div className="text-center py-8">
        <Shield className="h-12 w-12 text-gray-400 mx-auto mb-4" />
        <h3 className="text-lg font-medium text-gray-900 mb-2">
          No Safes Found
        </h3>
        <p className="text-gray-500">
          {isOwnerRole
            ? "Register your first safe to get started"
            : "No safes have been assigned to your account yet"}
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {safesList.map((safe) => (
        <div
          key={safe.id}
          className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <div
                className={`p-2 rounded-lg ${
                  safe.status === "active"
                    ? "bg-green-100"
                    : safe.status === "offline"
                    ? "bg-red-100"
                    : "bg-gray-100"
                }`}
              >
                <Shield
                  className={`h-6 w-6 ${
                    safe.status === "active"
                      ? "text-green-600"
                      : safe.status === "offline"
                      ? "text-red-600"
                      : "text-gray-600"
                  }`}
                />
              </div>

              <div>
                <h3 className="font-medium text-gray-900">
                  Safe {safe.serial_number}
                </h3>
                <p className="text-sm text-gray-500">ID: {safe.id.slice(-8)}</p>
              </div>
            </div>

            <div className="flex items-center space-x-6">
              {/* Status */}
              <div className="text-center">
                <span
                  className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(
                    safe.status
                  )}`}
                >
                  {safe.status}
                </span>
              </div>

              {/* Battery */}
              <div className="flex items-center space-x-1">
                <Battery
                  className={`h-4 w-4 ${getBatteryColor(safe.battery_level)}`}
                />
                <span
                  className={`text-sm font-medium ${getBatteryColor(
                    safe.battery_level
                  )}`}
                >
                  {safe.battery_level}%
                </span>
              </div>

              {/* Lock Status */}
              <div className="flex items-center space-x-1">
                {safe.is_locked ? (
                  <Lock className="h-4 w-4 text-gray-600" />
                ) : (
                  <Unlock className="h-4 w-4 text-orange-600" />
                )}
                <span className="text-sm text-gray-600">
                  {safe.is_locked ? "Locked" : "Unlocked"}
                </span>
              </div>

              {/* Last Update */}
              <div className="text-right">
                <p className="text-sm text-gray-500">
                  {safe.last_update ? (
                    <>
                      <Activity className="h-3 w-3 inline mr-1" />
                      {formatDistanceToNow(new Date(safe.last_update))} ago
                    </>
                  ) : (
                    "No recent activity"
                  )}
                </p>
              </div>
            </div>
          </div>

          {/* Additional Info */}
          <div className="mt-3 flex items-center justify-between text-sm text-gray-500">
            <div className="flex items-center space-x-4">
              {safe.tracking_device_id && (
                <div className="flex items-center space-x-1">
                  <MapPin className="h-3 w-3" />
                  <span>Tracking: {safe.tracking_device_id}</span>
                </div>
              )}
              <span>Device: {safe.device_hash.slice(0, 8)}...</span>
            </div>

            {/* Actions for Owner */}
            {showActions && isOwnerRole && (
              <div className="flex space-x-2">
                {updatingStatus === safe.id ? (
                  <LoadingSpinner size="small" />
                ) : (
                  <>
                    {safe.status === "inactive" && (
                      <button
                        onClick={() => handleStatusChange(safe.id, "active")}
                        className="text-green-600 hover:text-green-800 text-xs"
                      >
                        Activate
                      </button>
                    )}
                    {safe.status === "active" && (
                      <button
                        onClick={() =>
                          handleStatusChange(safe.id, "maintenance")
                        }
                        className="text-yellow-600 hover:text-yellow-800 text-xs"
                      >
                        Maintenance
                      </button>
                    )}
                    {safe.status === "maintenance" && (
                      <button
                        onClick={() => handleStatusChange(safe.id, "active")}
                        className="text-green-600 hover:text-green-800 text-xs"
                      >
                        Reactivate
                      </button>
                    )}
                  </>
                )}
              </div>
            )}
          </div>

          {/* Battery Warning */}
          {safe.battery_level < 20 && (
            <div className="mt-2 bg-red-50 border border-red-200 rounded p-2">
              <p className="text-sm text-red-700">
                âš ï¸ Low battery warning - {safe.battery_level}% remaining
              </p>
            </div>
          )}
        </div>
      ))}
    </div>
  );
}
</file>

<file path="src/components/StatsCards.tsx">
import { Shield, Package, Activity, TrendingUp } from "lucide-preact";

interface StatsCardsProps {
  stats: {
    totalSafes: number;
    activeSafes: number;
    totalTrips: number;
    activeTrips: number;
  };
}

export function StatsCards({ stats }: StatsCardsProps) {
  const cards = [
    {
      title: "Total Safes",
      value: stats.totalSafes,
      icon: Shield,
      color: "bg-blue-500",
    },
    {
      title: "Active Safes",
      value: stats.activeSafes,
      icon: Activity,
      color: "bg-green-500",
    },
    {
      title: "Total Trips",
      value: stats.totalTrips,
      icon: Package,
      color: "bg-purple-500",
    },
    {
      title: "Active Trips",
      value: stats.activeTrips,
      icon: TrendingUp,
      color: "bg-orange-500",
    },
  ];

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      {cards.map((card) => {
        const IconComponent = card.icon;
        return (
          <div key={card.title} className="card">
            <div className="flex items-center">
              <div className={`p-3 rounded-lg ${card.color}`}>
                <IconComponent className="h-6 w-6 text-white" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-500">
                  {card.title}
                </p>
                <p className="text-2xl font-semibold text-gray-900">
                  {card.value}
                </p>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="src/components/TripsList.tsx">
import { useState } from "preact/hooks";
import {
  Package,
  MapPin,
  Calendar,
  User,
  Clock,
  Navigation,
} from "lucide-preact";
import { trips, safes } from "../store/data";
import { currentUser, isOwner } from "../store/auth";
import { dataService } from "../services/data";
import { LoadingSpinner } from "./LoadingSpinner";
import { TripTrackingModal } from "./TripTrackingModal";
import { format, isToday, isPast } from "date-fns";
import { Copy, ExternalLink } from "lucide-preact";

interface TripsListProps {
  limit?: number;
  showActions?: boolean;
}

export function TripsList({ limit, showActions = true }: TripsListProps) {
  const [updatingStatus, setUpdatingStatus] = useState<string | null>(null);
  const [copyingTracking, setCopyingTracking] = useState<string | null>(null);
  const [trackingTrip, setTrackingTrip] = useState<any>(null);

  const user = currentUser.value;
  const isOwnerRole = isOwner.value;

  let tripsList = trips.value;
  const safesList = safes.value;

  // Filter trips based on user role
  if (!isOwnerRole && user) {
    const userSafeIds = safesList
      .filter((safe) => safe.assigned_to === user.id)
      .map((safe) => safe.id);
    tripsList = tripsList.filter((trip) => userSafeIds.includes(trip.safe_id));
  }

  // Apply limit if specified
  if (limit) {
    tripsList = tripsList.slice(0, limit);
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case "pending":
        return "text-blue-600 bg-blue-100";
      case "in_transit":
        return "text-yellow-600 bg-yellow-100";
      case "delivered":
        return "text-green-600 bg-green-100";
      case "cancelled":
        return "text-gray-600 bg-gray-100";
      default:
        return "text-gray-600 bg-gray-100";
    }
  };

  const getSafeInfo = (safeId: string) => {
    return safesList.find((safe) => safe.id === safeId);
  };

  const getTimeStatus = (scheduledTime: string) => {
    const time = new Date(scheduledTime);
    if (isPast(time)) return "text-red-600";
    if (isToday(time)) return "text-yellow-600";
    return "text-gray-600";
  };

  const handleStatusChange = async (tripId: string, newStatus: any) => {
    setUpdatingStatus(tripId);
    try {
      await dataService.updateTripStatus(tripId, newStatus);
    } catch (error) {
      console.error("Failed to update trip status:", error);
    } finally {
      setUpdatingStatus(null);
    }
  };

  const copyTrackingUrl = async (trackingToken: string, tripId: string) => {
    setCopyingTracking(tripId);
    try {
      const trackingUrl = dataService.generateTrackingUrl(trackingToken);
      await navigator.clipboard.writeText(trackingUrl);
      setTimeout(() => setCopyingTracking(null), 1000);
    } catch (err) {
      console.error("Failed to copy tracking URL:", err);
      setCopyingTracking(null);
    }
  };

  const toggleTracking = async (tripId: string, currentEnabled: boolean) => {
    setUpdatingStatus(tripId);
    try {
      await dataService.toggleCustomerTracking(tripId, !currentEnabled);
    } catch (error) {
      console.error("Failed to toggle customer tracking:", error);
    } finally {
      setUpdatingStatus(null);
    }
  };

  // Check if safe has tracking device
  const canTrackTrip = (safeId: string) => {
    const safe = getSafeInfo(safeId);
    return safe && (safe.tracknetics_device_id || safe.tracking_device_id);
  };

  if (tripsList.length === 0) {
    return (
      <div className="text-center py-8">
        <Package className="h-12 w-12 text-gray-400 mx-auto mb-4" />
        <h3 className="text-lg font-medium text-gray-900 mb-2">
          No Trips Found
        </h3>
        <p className="text-gray-500">
          {isOwnerRole
            ? "No trips have been booked yet"
            : "Book your first trip to get started"}
        </p>
      </div>
    );
  }

  return (
    <>
      <div className="space-y-4">
        {tripsList.map((trip) => {
          const safe = getSafeInfo(trip.safe_id);
          const isOverdue =
            isPast(new Date(trip.scheduled_delivery)) &&
            trip.status !== "delivered";
          const canTrack = canTrackTrip(trip.safe_id);

          return (
            <div
              key={trip.id}
              className={`border rounded-lg p-4 hover:shadow-md transition-shadow ${
                isOverdue ? "border-red-200 bg-red-50" : "border-gray-200"
              }`}
            >
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center space-x-4">
                  <div
                    className={`p-2 rounded-lg ${
                      trip.status === "delivered"
                        ? "bg-green-100"
                        : trip.status === "in_transit"
                        ? "bg-yellow-100"
                        : trip.status === "cancelled"
                        ? "bg-gray-100"
                        : "bg-blue-100"
                    }`}
                  >
                    <Package
                      className={`h-6 w-6 ${
                        trip.status === "delivered"
                          ? "text-green-600"
                          : trip.status === "in_transit"
                          ? "text-yellow-600"
                          : trip.status === "cancelled"
                          ? "text-gray-600"
                          : "text-blue-600"
                      }`}
                    />
                  </div>

                  <div>
                    <h3 className="font-medium text-gray-900 flex items-center space-x-2">
                      <User className="h-4 w-4 text-gray-400" />
                      <span>{trip.client_name}</span>
                    </h3>
                    <p className="text-sm text-gray-500">
                      Trip ID: {trip.id.slice(-8)}
                    </p>
                  </div>
                </div>

                <div className="flex items-center space-x-4">
                  <span
                    className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(
                      trip.status
                    )}`}
                  >
                    {trip.status.replace("_", " ")}
                  </span>

                  {isOverdue && (
                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium text-red-600 bg-red-100">
                      Overdue
                    </span>
                  )}

                  {/* Live Tracking Button - Only for in-transit trips with tracking devices */}
                  {trip.status === "in_transit" && canTrack && (
                    <button
                      onClick={() => setTrackingTrip(trip)}
                      className="inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium text-purple-600 bg-purple-100 hover:bg-purple-200 transition-colors"
                      title="Live GPS Tracking"
                    >
                      <Navigation className="h-4 w-4 mr-1" />
                      Live Tracking
                    </button>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                <div>
                  <div className="flex items-start space-x-2 mb-2">
                    <MapPin className="h-4 w-4 text-green-600 mt-0.5 flex-shrink-0" />
                    <div>
                      <p className="text-sm font-medium text-gray-700">
                        Pickup
                      </p>
                      <p className="text-sm text-gray-600">
                        {trip.pickup_address}
                      </p>
                    </div>
                  </div>
                </div>

                <div>
                  <div className="flex items-start space-x-2">
                    <MapPin className="h-4 w-4 text-red-600 mt-0.5 flex-shrink-0" />
                    <div>
                      <p className="text-sm font-medium text-gray-700">
                        Delivery
                      </p>
                      <p className="text-sm text-gray-600">
                        {trip.delivery_address}
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3 text-sm">
                <div className="flex items-center space-x-2">
                  <Calendar className="h-4 w-4 text-gray-400" />
                  <div>
                    <p className="font-medium text-gray-700">Pickup</p>
                    <p className={getTimeStatus(trip.scheduled_pickup)}>
                      {format(new Date(trip.scheduled_pickup), "MMM d, HH:mm")}
                    </p>
                  </div>
                </div>

                <div className="flex items-center space-x-2">
                  <Calendar className="h-4 w-4 text-gray-400" />
                  <div>
                    <p className="font-medium text-gray-700">Delivery</p>
                    <p className={getTimeStatus(trip.scheduled_delivery)}>
                      {format(
                        new Date(trip.scheduled_delivery),
                        "MMM d, HH:mm"
                      )}
                    </p>
                  </div>
                </div>

                <div className="flex items-center space-x-2">
                  <Package className="h-4 w-4 text-gray-400" />
                  <div>
                    <p className="font-medium text-gray-700">Safe</p>
                    <p className="text-gray-600">
                      {safe ? safe.serial_number : "Unknown"}
                    </p>
                    {!canTrack && (
                      <p className="text-xs text-gray-400">No GPS tracker</p>
                    )}
                  </div>
                </div>
              </div>

              {trip && trip.special_instructions && (
                <div className="mb-3 p-3 bg-blue-50 rounded border border-blue-200">
                  <p className="text-sm text-blue-800">
                    <strong>Instructions:</strong> {trip.special_instructions}
                  </p>
                </div>
              )}

              {/* Actions */}
              {showActions && (
                <div className="flex items-center justify-between pt-3 border-t border-gray-200">
                  <div className="text-sm text-gray-500">
                    <Clock className="h-3 w-3 inline mr-1" />
                    Created {format(new Date(trip.created_at), "MMM d, HH:mm")}
                  </div>

                  <div className="flex items-center space-x-2">
                    {/* Customer Tracking Controls */}
                    {trip && trip.client_email && trip.tracking_token && (
                      <div className="flex items-center space-x-1 mr-3 border-r border-gray-200 pr-3">
                        {trip.customer_tracking_enabled ?? false ? (
                          <>
                            <button
                              onClick={() =>
                                copyTrackingUrl(trip.tracking_token!, trip.id)
                              }
                              disabled={copyingTracking === trip.id}
                              className="text-blue-600 hover:text-blue-800 text-sm flex items-center space-x-1"
                              title="Copy customer tracking link"
                            >
                              {copyingTracking === trip.id ? (
                                <LoadingSpinner size="small" />
                              ) : (
                                <Copy className="h-3 w-3" />
                              )}
                              <span className="hidden sm:inline">
                                {copyingTracking === trip.id
                                  ? "Copied!"
                                  : "Copy Link"}
                              </span>
                            </button>
                            <button
                              onClick={() =>
                                window.open(
                                  dataService.generateTrackingUrl(
                                    trip.tracking_token!
                                  ),
                                  "_blank"
                                )
                              }
                              className="text-green-600 hover:text-green-800 text-sm"
                              title="View customer tracking page"
                            >
                              <ExternalLink className="h-3 w-3" />
                            </button>
                            <button
                              onClick={() =>
                                toggleTracking(
                                  trip.id,
                                  trip.customer_tracking_enabled ?? false
                                )
                              }
                              className="text-red-600 hover:text-red-800 text-sm"
                              title="Disable customer tracking"
                            >
                              Hide
                            </button>
                          </>
                        ) : (
                          <button
                            onClick={() =>
                              toggleTracking(
                                trip.id,
                                trip.customer_tracking_enabled ?? false
                              )
                            }
                            className="text-blue-600 hover:text-blue-800 text-sm"
                            title="Enable customer tracking"
                          >
                            Enable Tracking
                          </button>
                        )}
                      </div>
                    )}

                    {/* Status Change Actions */}
                    {updatingStatus === trip.id ? (
                      <LoadingSpinner size="small" />
                    ) : (
                      <>
                        {trip.status === "pending" && (
                          <button
                            onClick={() =>
                              handleStatusChange(trip.id, "in_transit")
                            }
                            className="text-yellow-600 hover:text-yellow-800 text-sm"
                          >
                            Start Transit
                          </button>
                        )}
                        {trip.status === "in_transit" && (
                          <button
                            onClick={() =>
                              handleStatusChange(trip.id, "delivered")
                            }
                            className="text-green-600 hover:text-green-800 text-sm"
                          >
                            Mark Delivered
                          </button>
                        )}
                        {trip.status !== "delivered" &&
                          trip.status !== "cancelled" && (
                            <button
                              onClick={() =>
                                handleStatusChange(trip.id, "cancelled")
                              }
                              className="text-red-600 hover:text-red-800 text-sm"
                            >
                              Cancel
                            </button>
                          )}
                      </>
                    )}
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Trip Tracking Modal */}
      {trackingTrip && (
        <TripTrackingModal
          trip={trackingTrip}
          onClose={() => setTrackingTrip(null)}
        />
      )}
    </>
  );
}
</file>

<file path="src/components/TripTrackingModal.tsx">
import { useState, useEffect, useRef } from "preact/hooks";
import {
  X,
  Navigation,
  RefreshCw,
  Clock,
  User,
  Package,
  AlertTriangle,
  Smartphone,
  Route,
} from "lucide-preact";
import { LoadingSpinner } from "./LoadingSpinner";
import { trackneticsService } from "../services/tracknetics";
import { safes } from "../store/data";
import { formatDistanceToNow, format } from "date-fns";
import L from "leaflet";
import {
  fixLeafletIcons,
  createArrowIcon,
  getOpenStreetMapLayer,
} from "../utils/leafletHelpers";

interface TripTrackingModalProps {
  trip: {
    id: string;
    safe_id: string;
    client_name: string;
    pickup_address: string;
    delivery_address: string;
    status: string;
    scheduled_pickup: string;
    scheduled_delivery: string;
    special_instructions?: string;
    priority?: string;
  };
  onClose: () => void;
}

interface SafeLocationData {
  location?: {
    lat: number;
    lng: number;
    accuracy: number;
    timestamp: number;
    speed?: number;
  };
  status: "online" | "offline" | "no_tracker" | "error";
  error?: string;
  lastUpdate: Date;
}

export function TripTrackingModal({ trip, onClose }: TripTrackingModalProps) {
  const [location, setLocation] = useState<SafeLocationData>({
    status: "offline",
    lastUpdate: new Date(),
  });
  const [loading, setLoading] = useState(false);
  const [lastUpdate, setLastUpdate] = useState<Date | null>(null);
  const [autoRefresh, setAutoRefresh] = useState(true);

  const mapRef = useRef<HTMLDivElement>(null);
  const leafletMapRef = useRef<L.Map | null>(null);
  const safeMarkerRef = useRef<L.Marker | null>(null);
  const [mapsLoaded, setMapsLoaded] = useState(false);
  const [mapsError, setMapsError] = useState<string>("");

  // Get safe info
  const safe = safes.value.find((s) => s.id === trip.safe_id);
  const deviceId = safe?.tracknetics_device_id || safe?.tracking_device_id;

  // Get mobile app username (assuming it's tied to safe)
  const mobileUsername =
    safe?.mobile_users?.[0]?.username ||
    (safe?.serial_number
      ? safe.serial_number.toLowerCase().replace(/[^a-z0-9]/g, "") + "_driver"
      : "Unknown");

  // Initialize Leaflet map
  const initializeMap = () => {
    if (!mapRef.current || leafletMapRef.current || mapsError) return;

    console.log("ðŸ—ºï¸ Initializing trip tracking map...");

    try {
      fixLeafletIcons();

      const map = L.map(mapRef.current, {
        center: [-26.2041, 28.0473], // Default to Johannesburg
        zoom: 13,
        zoomControl: true,
      });

      getOpenStreetMapLayer().addTo(map);

      leafletMapRef.current = map;
      setMapsLoaded(true);

      console.log("âœ… Trip tracking map initialized and ready");

      // If we already have location data, update marker immediately
      if (location.location) {
        console.log("ðŸ”„ Map ready, updating marker with existing location");
        updateSafeMarker();
      }
    } catch (error) {
      console.error("âŒ Error initializing trip map:", error);
      setMapsError("Failed to initialize map");
    }
  };

  // Update safe marker position
  const updateSafeMarker = () => {
    if (!leafletMapRef.current) {
      console.log("â³ Skipping marker update - map not available");
      return;
    }

    if (!location.location) {
      console.log("â³ Skipping marker update - no location data");
      return;
    }

    const position: L.LatLngExpression = [
      location.location.lat,
      location.location.lng,
    ];

    console.log("ðŸ“ Updating safe marker at:", position);

    try {
      if (!safeMarkerRef.current) {
        // Create safe marker with arrow icon
        const icon =
          location.location.speed && location.location.speed > 5
            ? createArrowIcon("#8B5CF6", 0) // Purple arrow
            : L.divIcon({
                className: "custom-safe-marker",
                html: `<div style="
                background-color: #8B5CF6;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 3px 6px rgba(0,0,0,0.3);
              "></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
              });

        safeMarkerRef.current = L.marker(position, { icon }).addTo(
          leafletMapRef.current
        );

        // Safe marker info
        const popupContent = `
          <div style="padding: 8px; min-width: 200px;">
            <h3 style="margin: 0 0 8px 0; color: #8B5CF6;">ðŸšš Safe ${
              safe?.serial_number
            }</h3>
            <div style="font-size: 12px; line-height: 1.4;">
              <p style="margin: 2px 0;"><strong>Driver:</strong> ${mobileUsername}</p>
              <p style="margin: 2px 0;"><strong>Client:</strong> ${
                trip.client_name
              }</p>
              <p style="margin: 2px 0;"><strong>Status:</strong> ${
                location.status
              }</p>
              <p style="margin: 2px 0;"><strong>Location:</strong> ${position[0].toFixed(
                6
              )}, ${position[1].toFixed(6)}</p>
              <p style="margin: 2px 0;"><strong>Accuracy:</strong> Â±${
                location.location.accuracy
              }m</p>
              ${
                location.location.speed
                  ? `<p style="margin: 2px 0;"><strong>Speed:</strong> ${location.location.speed} km/h</p>`
                  : ""
              }
              <p style="margin: 2px 0;"><strong>Updated:</strong> ${formatDistanceToNow(
                location.lastUpdate
              )} ago</p>
            </div>
          </div>
        `;

        safeMarkerRef.current.bindPopup(popupContent);

        // Center map on safe location
        leafletMapRef.current.setView(position, 15);
        console.log("âœ… Safe marker created and map centered");
      } else {
        // Update existing marker position
        safeMarkerRef.current.setLatLng(position);
        // Re-center map on updated position
        leafletMapRef.current.setView(
          position,
          leafletMapRef.current.getZoom()
        );
        console.log("âœ… Safe marker position updated");
      }
    } catch (error) {
      console.error("âŒ Error updating safe marker:", error);
    }
  };

  // Get current safe location
  const updateLocation = async () => {
    if (!deviceId) {
      setLocation({
        status: "no_tracker",
        error: "No tracking device assigned",
        lastUpdate: new Date(),
      });
      return;
    }

    setLoading(true);

    try {
      console.log(
        `ðŸ“ Getting location for safe ${safe?.serial_number} (device: ${deviceId})`
      );

      const result = await trackneticsService.getLocationByDeviceId(deviceId);

      if (result.success && result.location) {
        const newLocation: SafeLocationData = {
          location: result.location,
          status: "online",
          lastUpdate: new Date(),
        };
        setLocation(newLocation);
        setLastUpdate(new Date());

        console.log(
          `âœ… Location updated for ${safe?.serial_number}:`,
          result.location
        );
      } else {
        setLocation({
          status: "offline",
          error: result.error || "No location data",
          lastUpdate: new Date(),
        });
        console.log(`âŒ No location for ${safe?.serial_number}:`, result.error);
      }
    } catch (error: any) {
      setLocation({
        status: "error",
        error: error.message || "Failed to get location",
        lastUpdate: new Date(),
      });
      console.error(
        `ðŸ’¥ Error getting location for ${safe?.serial_number}:`,
        error
      );
    } finally {
      setLoading(false);
    }
  };

  // Initialize
  useEffect(() => {
    initializeMap();

    return () => {
      if (leafletMapRef.current) {
        leafletMapRef.current.remove();
        leafletMapRef.current = null;
      }
    };
  }, []);

  // Update safe marker when location changes
  useEffect(() => {
    if (mapsLoaded && location.location && !mapsError) {
      updateSafeMarker();
    }
  }, [location, mapsLoaded, mapsError]);

  // Auto-refresh location
  useEffect(() => {
    updateLocation();

    if (autoRefresh) {
      const interval = setInterval(updateLocation, 30000);
      return () => clearInterval(interval);
    }
  }, [deviceId, autoRefresh]);

  const getStatusColor = () => {
    switch (location.status) {
      case "online":
        return "text-green-600 bg-green-100";
      case "offline":
        return "text-red-600 bg-red-100";
      case "no_tracker":
        return "text-gray-600 bg-gray-100";
      case "error":
        return "text-orange-600 bg-orange-100";
      default:
        return "text-gray-600 bg-gray-100";
    }
  };

  const getPriorityColor = () => {
    switch (trip.priority) {
      case "urgent":
        return "text-red-600 bg-red-100";
      case "high":
        return "text-orange-600 bg-orange-100";
      case "normal":
        return "text-blue-600 bg-blue-100";
      case "low":
        return "text-gray-600 bg-gray-100";
      default:
        return "text-blue-600 bg-blue-100";
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col">
        {/* Header */}
        <div className="flex items-center justify-between p-6 border-b">
          <div className="flex items-center space-x-4">
            <div className="bg-purple-100 rounded-lg p-3">
              <Route className="h-6 w-6 text-purple-600" />
            </div>
            <div>
              <h2 className="text-2xl font-bold text-gray-900">
                Live Tracking
              </h2>
              <p className="text-gray-500">
                Trip {trip.id.slice(-8).toUpperCase()} â€¢ Safe{" "}
                {safe?.serial_number}
              </p>
            </div>
          </div>

          <div className="flex items-center space-x-3">
            <span
              className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getPriorityColor()}`}
            >
              {trip.priority?.toUpperCase() || "NORMAL"} PRIORITY
            </span>

            <button
              onClick={updateLocation}
              disabled={loading}
              className="btn btn-secondary"
            >
              {loading ? (
                <LoadingSpinner size="small" className="mr-2" />
              ) : (
                <RefreshCw className="h-4 w-4 mr-2" />
              )}
              Refresh
            </button>

            <button
              onClick={onClose}
              className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
            >
              <X className="h-6 w-6 text-gray-500" />
            </button>
          </div>
        </div>

        <div className="flex flex-1 overflow-hidden">
          {/* Trip Info Sidebar */}
          <div className="w-80 border-r bg-gray-50 p-6 overflow-y-auto">
            <div className="space-y-6">
              {/* Client Info */}
              <div className="bg-white rounded-lg p-4">
                <div className="flex items-center space-x-3 mb-3">
                  <User className="h-5 w-5 text-blue-600" />
                  <h3 className="font-semibold text-gray-900">Client</h3>
                </div>
                <p className="text-gray-900 font-medium">{trip.client_name}</p>
                <p className="text-sm text-gray-500 mt-1">
                  Priority: {trip.priority?.toUpperCase() || "NORMAL"}
                </p>
              </div>

              {/* Safe Status */}
              <div className="bg-white rounded-lg p-4">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center space-x-3">
                    <Package className="h-5 w-5 text-purple-600" />
                    <h3 className="font-semibold text-gray-900">Safe Status</h3>
                  </div>
                  <span
                    className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor()}`}
                  >
                    {location.status.toUpperCase()}
                  </span>
                </div>

                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-500">Serial:</span>
                    <span className="font-mono">{safe?.serial_number}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-500">Battery:</span>
                    <span
                      className={`font-medium ${
                        (safe?.battery_level || 0) > 50
                          ? "text-green-600"
                          : (safe?.battery_level || 0) > 20
                          ? "text-yellow-600"
                          : "text-red-600"
                      }`}
                    >
                      {safe?.battery_level}%
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-500">Lock Status:</span>
                    <span
                      className={
                        safe?.is_locked ? "text-green-600" : "text-red-600"
                      }
                    >
                      {safe?.is_locked ? "SECURED" : "OPEN"}
                    </span>
                  </div>
                </div>
              </div>

              {/* Driver Info */}
              <div className="bg-white rounded-lg p-4">
                <div className="flex items-center space-x-3 mb-3">
                  <Smartphone className="h-5 w-5 text-green-600" />
                  <h3 className="font-semibold text-gray-900">Driver</h3>
                </div>
                <p className="text-gray-900 font-medium">{mobileUsername}</p>
                <p className="text-sm text-gray-500">Mobile App User</p>
              </div>

              {/* Location Info */}
              {location.location && (
                <div className="bg-white rounded-lg p-4">
                  <div className="flex items-center space-x-3 mb-3">
                    <Navigation className="h-5 w-5 text-blue-600" />
                    <h3 className="font-semibold text-gray-900">
                      Current Location
                    </h3>
                  </div>
                  <div className="space-y-2 text-sm">
                    <div>
                      <span className="text-gray-500">Coordinates:</span>
                      <p className="font-mono text-xs">
                        {location.location.lat.toFixed(6)},{" "}
                        {location.location.lng.toFixed(6)}
                      </p>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500">Accuracy:</span>
                      <span>Â±{location.location.accuracy}m</span>
                    </div>
                    {location.location.speed && (
                      <div className="flex justify-between">
                        <span className="text-gray-500">Speed:</span>
                        <span>{location.location.speed} km/h</span>
                      </div>
                    )}
                    <div className="flex justify-between">
                      <span className="text-gray-500">Updated:</span>
                      <span>
                        {formatDistanceToNow(location.lastUpdate)} ago
                      </span>
                    </div>
                  </div>
                </div>
              )}

              {/* Schedule */}
              <div className="bg-white rounded-lg p-4">
                <div className="flex items-center space-x-3 mb-3">
                  <Clock className="h-5 w-5 text-orange-600" />
                  <h3 className="font-semibold text-gray-900">Schedule</h3>
                </div>
                <div className="space-y-3 text-sm">
                  <div>
                    <p className="text-gray-500">Pickup:</p>
                    <p className="font-medium">
                      {format(
                        new Date(trip.scheduled_pickup),
                        "MMM d, yyyy 'at' HH:mm"
                      )}
                    </p>
                  </div>
                  <div>
                    <p className="text-gray-500">Delivery:</p>
                    <p className="font-medium">
                      {format(
                        new Date(trip.scheduled_delivery),
                        "MMM d, yyyy 'at' HH:mm"
                      )}
                    </p>
                  </div>
                </div>
              </div>

              {/* Special Instructions */}
              {trip.special_instructions && (
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <div className="flex items-center space-x-3 mb-2">
                    <AlertTriangle className="h-5 w-5 text-yellow-600" />
                    <h3 className="font-semibold text-yellow-800">
                      Special Instructions
                    </h3>
                  </div>
                  <p className="text-yellow-700 text-sm">
                    {trip.special_instructions}
                  </p>
                </div>
              )}

              {/* Auto-refresh Toggle */}
              <div className="bg-white rounded-lg p-4">
                <label className="flex items-center space-x-3">
                  <input
                    type="checkbox"
                    checked={autoRefresh}
                    onChange={(e) =>
                      setAutoRefresh((e.target as HTMLInputElement).checked)
                    }
                    className="rounded"
                  />
                  <div>
                    <span className="font-medium text-gray-900">
                      Auto-refresh
                    </span>
                    <p className="text-xs text-gray-500">
                      Updates every 30 seconds
                    </p>
                  </div>
                </label>
              </div>
            </div>
          </div>

          {/* Map */}
          <div className="flex-1 relative">
            {/* Maps Error State */}
            {mapsError && (
              <div className="absolute inset-0 flex items-center justify-center bg-gray-100">
                <div className="text-center">
                  <AlertTriangle className="h-12 w-12 mx-auto mb-4 text-red-400" />
                  <p className="text-lg font-medium mb-2">Map Error</p>
                  <p className="text-gray-600 text-sm max-w-xs mb-4">
                    {mapsError}
                  </p>
                  <button
                    onClick={() => {
                      setMapsError("");
                      setMapsLoaded(false);
                      initializeMap();
                    }}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors"
                  >
                    Retry
                  </button>
                </div>
              </div>
            )}

            {/* Map Container */}
            <div
              ref={mapRef}
              className="w-full h-full"
              style={{
                display: !mapsError ? "block" : "none",
                minHeight: "400px",
              }}
            />

            {/* Map Legend */}
            {mapsLoaded && !mapsError && location.location && (
              <div className="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-3">
                <div className="flex items-center space-x-2 text-sm">
                  <div className="w-4 h-4 rounded-full bg-purple-500"></div>
                  <span>Safe Position</span>
                </div>
              </div>
            )}

            {/* Status Badge */}
            <div className="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-3">
              <div className="flex items-center space-x-2">
                <div
                  className={`w-2 h-2 rounded-full ${
                    location.status === "online"
                      ? "bg-green-500"
                      : "bg-gray-400"
                  }`}
                ></div>
                <span className="text-sm font-medium">
                  {lastUpdate
                    ? `Updated ${formatDistanceToNow(lastUpdate)} ago`
                    : "No updates yet"}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/UsersList.tsx">
import { useState, useEffect } from "preact/hooks";
import { User, Calendar, Shield } from "lucide-preact";
import { supabase } from "../lib/supabase";
import { LoadingSpinner } from "./LoadingSpinner";
import { format } from "date-fns";

interface UserData {
  id: string;
  username: string;
  role: string;
  is_active: boolean;
  created_at: string;
  created_by: string | null;
}

export function UsersList() {
  const [users, setUsers] = useState<UserData[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    loadUsers();
  }, []);

  const loadUsers = async () => {
    try {
      const { data, error } = await supabase
        .from("profiles") // Changed from "users"
        .select("id, username, role, is_active, created_at, created_by")
        .order("created_at", { ascending: false });

      if (error) {
        setError(error.message);
      } else {
        setUsers(data || []);
      }
    } catch (err) {
      setError("Failed to load users");
    } finally {
      setLoading(false);
    }
  };

  const toggleUserStatus = async (userId: string, currentStatus: boolean) => {
    try {
      const { error } = await supabase
        .from("profiles") // Changed from "users"
        .update({ is_active: !currentStatus })
        .eq("id", userId);

      if (error) {
        console.error("Failed to update user status:", error);
      } else {
        // Refresh users list
        loadUsers();
      }
    } catch (err) {
      console.error("Error updating user status:", err);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-8">
        <LoadingSpinner size="medium" />
        <span className="ml-2 text-gray-600">Loading users...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
        Error: {error}
      </div>
    );
  }

  const adminUsers = users.filter((user) => user.role === "admin");
  const ownerUsers = users.filter((user) => user.role === "owner");

  return (
    <div className="space-y-6">
      {/* Owner Users */}
      {ownerUsers.length > 0 && (
        <div className="card">
          <h3 className="text-lg font-medium text-gray-900 mb-4 flex items-center space-x-2">
            <Shield className="h-5 w-5 text-purple-600" />
            <span>Owner Accounts ({ownerUsers.length})</span>
          </h3>

          <div className="space-y-3">
            {ownerUsers.map((user) => (
              <div
                key={user.id}
                className="border border-gray-200 rounded-lg p-4"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="bg-purple-100 rounded-full p-2">
                      <Shield className="h-5 w-5 text-purple-600" />
                    </div>

                    <div>
                      <h4 className="font-medium text-gray-900">
                        {user.username}
                      </h4>
                      <div className="flex items-center space-x-4 text-sm text-gray-500">
                        <div className="flex items-center space-x-1">
                          <Calendar className="h-3 w-3" />
                          <span>
                            Joined{" "}
                            {format(new Date(user.created_at), "MMM d, yyyy")}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center space-x-3">
                    <span
                      className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        user.is_active
                          ? "text-green-800 bg-green-100"
                          : "text-red-800 bg-red-100"
                      }`}
                    >
                      {user.is_active ? "Active" : "Inactive"}
                    </span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Admin Users */}
      <div className="card">
        <h3 className="text-lg font-medium text-gray-900 mb-4 flex items-center space-x-2">
          <User className="h-5 w-5 text-blue-600" />
          <span>Admin Accounts ({adminUsers.length})</span>
        </h3>

        {adminUsers.length === 0 ? (
          <div className="text-center py-8">
            <User className="h-12 w-12 text-gray-400 mx-auto mb-4" />
            <p className="text-gray-500">No admin users created yet</p>
          </div>
        ) : (
          <div className="space-y-3">
            {adminUsers.map((user) => (
              <div
                key={user.id}
                className="border border-gray-200 rounded-lg p-4"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="bg-blue-100 rounded-full p-2">
                      <User className="h-5 w-5 text-blue-600" />
                    </div>

                    <div>
                      <h4 className="font-medium text-gray-900">
                        {user.username}
                      </h4>
                      <div className="flex items-center space-x-4 text-sm text-gray-500">
                        <div className="flex items-center space-x-1">
                          <Calendar className="h-3 w-3" />
                          <span>
                            Joined{" "}
                            {format(new Date(user.created_at), "MMM d, yyyy")}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center space-x-3">
                    <span
                      className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        user.is_active
                          ? "text-green-800 bg-green-100"
                          : "text-red-800 bg-red-100"
                      }`}
                    >
                      {user.is_active ? "Active" : "Inactive"}
                    </span>

                    <button
                      onClick={() => toggleUserStatus(user.id, user.is_active)}
                      className={`text-sm ${
                        user.is_active
                          ? "text-red-600 hover:text-red-800"
                          : "text-green-600 hover:text-green-800"
                      }`}
                    >
                      {user.is_active ? "Deactivate" : "Activate"}
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/index.css">
@import "tailwindcss";

@layer base {
  body {
    font-family: system-ui, -apple-system, sans-serif;
  }
}

@layer components {
  .btn {
    @apply inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed;
  }

  .btn-primary {
    @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
  }

  .btn-secondary {
    @apply bg-gray-100 text-gray-900 hover:bg-gray-200 focus:ring-gray-500;
  }

  .btn-danger {
    @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
  }

  .input {
    @apply block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500;
  }

  .card {
    @apply bg-white rounded-lg shadow p-6;
  }
}
</file>

<file path="src/lib/supabase.ts">
import { createClient } from "@supabase/supabase-js";

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error("Missing Supabase environment variables");
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,
  },
});

// Database types (will be auto-generated from Supabase CLI)
export type Database = {
  public: {
    Tables: {
      users: {
        Row: {
          id: string;
          email: string;
          username: string;
          role: "owner" | "admin";
          created_by: string | null;
          must_change_password: boolean;
          is_active: boolean;
          created_at: string;
          updated_at: string;
        };
        Insert: {
          id?: string;
          email: string;
          username: string;
          role: "owner" | "admin";
          created_by?: string | null;
          must_change_password?: boolean;
          is_active?: boolean;
          created_at?: string;
          updated_at?: string;
        };
        Update: {
          id?: string;
          email?: string;
          username?: string;
          role?: "owner" | "admin";
          created_by?: string | null;
          must_change_password?: boolean;
          is_active?: boolean;
          created_at?: string;
          updated_at?: string;
        };
      };
      safes: {
        Row: {
          id: string;
          serial_number: string;
          device_hash: string;
          status: "active" | "inactive" | "maintenance" | "offline";
          battery_level: number;
          is_locked: boolean;
          tracking_device_id: string | null;
          assigned_to: string;
          last_update: string | null;
          created_at: string;
        };
        Insert: {
          id?: string;
          serial_number: string;
          device_hash: string;
          status?: "active" | "inactive" | "maintenance" | "offline";
          battery_level?: number;
          is_locked?: boolean;
          tracking_device_id?: string | null;
          assigned_to: string;
          last_update?: string | null;
          created_at?: string;
        };
        Update: {
          id?: string;
          serial_number?: string;
          device_hash?: string;
          status?: "active" | "inactive" | "maintenance" | "offline";
          battery_level?: number;
          is_locked?: boolean;
          tracking_device_id?: string | null;
          assigned_to?: string;
          last_update?: string | null;
          created_at?: string;
        };
      };
      trips: {
        Row: {
          id: string;
          safe_id: string;
          client_name: string;
          pickup_address: string;
          delivery_address: string;
          status: "pending" | "in_transit" | "delivered" | "cancelled";
          scheduled_pickup: string;
          scheduled_delivery: string;
          instructions: string | null;
          created_by: string;
          created_at: string;
          updated_at: string;
          tracking_token: string;
          customer_tracking_enabled: boolean;
          client_phone: string | null;
          client_email: string | null;
          pickup_contact_name: string | null;
          pickup_contact_phone: string | null;
          delivery_contact_name: string | null;
          delivery_contact_phone: string | null;
          priority: "low" | "normal" | "high" | "urgent" | null;
          special_instructions: string | null;
          delivery_notes: string | null;
          requires_signature: boolean | null;
          actual_pickup_time: string | null;
          actual_delivery_time: string | null;
          cancellation_reason: string | null;
          cancelled_at: string | null;
          recurring_config: any | null;
        };
        Insert: {
          id?: string;
          safe_id: string;
          client_name: string;
          pickup_address: string;
          delivery_address: string;
          status?: "pending" | "in_transit" | "delivered" | "cancelled";
          scheduled_pickup: string;
          scheduled_delivery: string;
          instructions?: string | null;
          created_by: string;
          created_at?: string;
          updated_at?: string;
          tracking_token?: string;
          customer_tracking_enabled?: boolean;
          client_phone?: string | null;
          client_email?: string | null;
          pickup_contact_name?: string | null;
          pickup_contact_phone?: string | null;
          delivery_contact_name?: string | null;
          delivery_contact_phone?: string | null;
          priority?: "low" | "normal" | "high" | "urgent" | null;
          special_instructions?: string | null;
          delivery_notes?: string | null;
          requires_signature?: boolean | null;
          actual_pickup_time?: string | null;
          actual_delivery_time?: string | null;
          cancellation_reason?: string | null;
          cancelled_at?: string | null;
          recurring_config?: any | null;
        };
        Update: {
          id?: string;
          safe_id?: string;
          client_name?: string;
          pickup_address?: string;
          delivery_address?: string;
          status?: "pending" | "in_transit" | "delivered" | "cancelled";
          scheduled_pickup?: string;
          scheduled_delivery?: string;
          instructions?: string | null;
          created_by?: string;
          created_at?: string;
          updated_at?: string;
          tracking_token?: string;
          customer_tracking_enabled?: boolean;
          client_phone?: string | null;
          client_email?: string | null;
          pickup_contact_name?: string | null;
          pickup_contact_phone?: string | null;
          delivery_contact_name?: string | null;
          delivery_contact_phone?: string | null;
          priority?: "low" | "normal" | "high" | "urgent" | null;
          special_instructions?: string | null;
          delivery_notes?: string | null;
          requires_signature?: boolean | null;
          actual_pickup_time?: string | null;
          actual_delivery_time?: string | null;
          cancellation_reason?: string | null;
          cancelled_at?: string | null;
          recurring_config?: any | null;
        };
      };
    };
  };
};
</file>

<file path="src/main.tsx">
import { render } from "preact";
import App from "./app.tsx";
import "./index.css";

render(<App />, document.getElementById("app")!);
</file>

<file path="src/services/auth.ts">
import { supabase } from "../lib/supabase";
import { authActions } from "../store/auth";
import type { User } from "../types";

class AuthService {
  async initialize() {
    authActions.setLoading(true);

    try {
      // Get current session
      const {
        data: { session },
        error,
      } = await supabase.auth.getSession();

      if (error) {
        console.error("Auth session error:", error);
        authActions.setLoading(false);
        return;
      }

      if (session?.user) {
        try {
          const userProfile = await this.getUserProfile(session.user.id);
          if (userProfile) {
            authActions.setUser(userProfile);
          } else {
            console.log("No profile found for user, logging out");
            await supabase.auth.signOut();
            authActions.setLoading(false);
          }
        } catch (profileError) {
          console.error("Error fetching user profile:", profileError);
          await supabase.auth.signOut();
          authActions.setLoading(false);
        }
      } else {
        authActions.setLoading(false);
      }

      // Listen for auth changes - Supabase handles this automatically
      supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === "SIGNED_IN" && session?.user) {
          try {
            const userProfile = await this.getUserProfile(session.user.id);
            if (userProfile) {
              authActions.setUser(userProfile);
            } else {
              console.log("No profile found after sign in");
              await supabase.auth.signOut();
            }
          } catch (profileError) {
            console.error(
              "Error fetching profile after sign in:",
              profileError
            );
            await supabase.auth.signOut();
          }
        } else if (event === "SIGNED_OUT") {
          authActions.logout();
        }
      });
    } catch (error) {
      console.error("Auth initialization failed:", error);
      authActions.setLoading(false);
    }
  }

  async login(email: string, password: string) {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      return { success: false, error: error.message };
    }

    if (data.user) {
      const userProfile = await this.getUserProfile(data.user.id);
      if (userProfile) {
        return {
          success: true,
          requiresPasswordChange: userProfile.must_change_password,
        };
      }
    }

    return { success: false, error: "User profile not found" };
  }

  async logout() {
    await supabase.auth.signOut();
  }

  async changePassword(newPassword: string) {
    const { error } = await supabase.auth.updateUser({
      password: newPassword,
    });

    if (error) {
      return { success: false, error: error.message };
    }

    // Update must_change_password flag using RLS-protected update
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (user) {
      await supabase
        .from("profiles") // Using profiles table
        .update({ must_change_password: false })
        .eq("id", user.id);

      authActions.updateUser({ must_change_password: false });
    }

    return { success: true };
  }

  // Create users using signup with email verification
  async createUser(userData: {
    email: string;
    username: string;
    password: string;
    role: "admin";
    created_by?: string;
  }) {
    try {
      // Use sign up with email verification instead of admin creation
      const { data, error } = await supabase.auth.signUp({
        email: userData.email,
        password: userData.password,
        options: {
          data: {
            username: userData.username,
            role: userData.role,
            must_change_password: true,
          },
          emailRedirectTo: `${window.location.origin}/login`,
        },
      });

      if (error) {
        return { success: false, error: error.message };
      }

      return {
        success: true,
        user: data.user,
        message:
          "User created! They will receive a confirmation email to activate their account.",
      };
    } catch (err) {
      console.error("Signup error:", err);
      return {
        success: false,
        error: "Failed to create user. Please try again.",
      };
    }
  }

  private async getUserProfile(userId: string): Promise<User | null> {
    try {
      const { data, error } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", userId)
        .eq("is_active", true)
        .single();

      if (error) {
        console.error("Failed to get user profile:", error);
        return null;
      }

      return data;
    } catch (err) {
      console.error("Exception getting user profile:", err);
      return null;
    }
  }
}

export const authService = new AuthService();
</file>

<file path="src/services/data.ts">
import { supabase } from "../lib/supabase";
import { dataActions } from "../store/data";
import { currentUser } from "../store/auth";
import type {
  Safe,
  Trip,
  SafeStatus,
  TripStatus,
  TripPriority,
} from "../types";

// Trip booking data interface
export interface TripBookingData {
  safe_id: string;
  client_name: string;
  client_phone?: string;
  client_email?: string;
  pickup_address: string;
  pickup_contact_name?: string;
  pickup_contact_phone?: string;
  delivery_address: string;
  delivery_contact_name?: string;
  delivery_contact_phone?: string;

  recipient_name?: string;
  recipient_email?: string;
  recipient_phone?: string;
  recipient_is_client?: boolean; // Toggle: "Same as client"

  scheduled_pickup: string;
  scheduled_delivery: string;
  priority?: TripPriority;
  special_instructions?: string;
  delivery_notes?: string;
  requires_signature?: boolean;
  recurring?: {
    enabled: boolean;
    frequency: "daily" | "weekly" | "monthly";
    end_date?: string;
    days_of_week?: number[];
  };
}

export interface TripValidationResult {
  isValid: boolean;
  errors: string[];
  warnings: string[];
}

class DataService {
  private safesSubscription: any = null;
  private tripsSubscription: any = null;

  async loadUserData() {
    const user = currentUser.value;
    if (!user) return;

    dataActions.setLoading(true);

    try {
      // Load data - RLS automatically filters based on user
      await Promise.all([this.loadSafes(), this.loadTrips()]);
    } catch (error) {
      console.error("Failed to load user data:", error);
    } finally {
      dataActions.setLoading(false);
    }
  }

  async loadSafes() {
    // RLS handles filtering - owner sees all, admin sees assigned
    const { data, error } = await supabase
      .from("safes")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Failed to load safes:", error);
      return;
    }

    dataActions.setSafes(data || []);
  }

  async loadTrips() {
    // RLS handles filtering automatically
    const { data, error } = await supabase
      .from("trips")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Failed to load trips:", error);
      return;
    }

    dataActions.setTrips(data || []);
  }

  async createSafe(safeData: {
    serial_number: string;
    device_hash: string;
    assigned_to: string;
    tracking_device_id?: string;
  }) {
    const { data, error } = await supabase
      .from("safes")
      .insert({
        ...safeData,
        status: "inactive",
        battery_level: 100,
        is_locked: true,
      })
      .select()
      .single();

    if (error) {
      return { success: false, error: error.message };
    }

    // No need to manually update store - real-time will handle it
    return { success: true, safe: data };
  }

  // Enhanced trip creation with validation and new fields
  async createTrip(tripData: any) {
    const user = currentUser.value;
    if (!user) {
      return { success: false, error: "User not authenticated" };
    }

    console.log("ðŸ“‹ Creating trip with data:", tripData);

    // Determine recipient
    const recipientName = tripData.recipient_is_client
      ? tripData.client_name
      : tripData.recipient_name;

    const recipientEmail = tripData.recipient_is_client
      ? tripData.client_email
      : tripData.recipient_email;

    const recipientPhone = tripData.recipient_is_client
      ? tripData.client_phone
      : tripData.recipient_phone;

    // Client always gets tracking link
    const customerTrackingEnabled = !!tripData.client_email;

    const enhancedTripData = {
      ...tripData,
      created_by: user.id,
      status: "pending",
      priority: tripData.priority || "normal",
      requires_signature: tripData.requires_signature || false,
      customer_tracking_enabled: customerTrackingEnabled,

      // NEW: Add recipient fields
      recipient_name: recipientName,
      recipient_email: recipientEmail,
      recipient_phone: recipientPhone,
      recipient_is_client: tripData.recipient_is_client || false,

      // Existing fields
      ...(tripData.client_phone && { client_phone: tripData.client_phone }),
      ...(tripData.client_email && { client_email: tripData.client_email }),
      ...(tripData.pickup_contact_name && {
        pickup_contact_name: tripData.pickup_contact_name,
      }),
      ...(tripData.pickup_contact_phone && {
        pickup_contact_phone: tripData.pickup_contact_phone,
      }),
      ...(tripData.delivery_contact_name && {
        delivery_contact_name: tripData.delivery_contact_name,
      }),
      ...(tripData.delivery_contact_phone && {
        delivery_contact_phone: tripData.delivery_contact_phone,
      }),
      ...(tripData.delivery_notes && {
        delivery_notes: tripData.delivery_notes,
      }),
      ...(tripData.recurring?.enabled && {
        recurring_config: tripData.recurring,
      }),
    };

    delete enhancedTripData.recurring;

    try {
      console.log("ðŸ’¾ Inserting trip into database...");
      const { data, error } = await supabase
        .from("trips")
        .insert(enhancedTripData)
        .select("*, tracking_token")
        .single();

      if (error) {
        console.error("âŒ Supabase error:", error);
        return { success: false, error: error.message };
      }

      console.log("âœ… Trip created successfully:", data);

      // Send booking confirmation to CLIENT
      if (enhancedTripData.client_email) {
        console.log("ðŸ“§ Sending booking confirmation to CLIENT...");
        await this.sendClientBookingConfirmation(data);
      }

      // NOTE: Recipient notification will be sent when driver arrives
      // OTP will be sent when driver requests it at delivery location

      return { success: true, trip: data };
    } catch (err) {
      console.error("ðŸ’¥ Exception creating trip:", err);
      return {
        success: false,
        error: "Failed to create trip booking. Please try again.",
      };
    }
  }

  // Validate trip data before submission
  validateTripData(
    data: TripBookingData,
    availableSafes: Safe[]
  ): TripValidationResult {
    const errors: string[] = [];
    const warnings: string[] = [];

    // Required field validation
    if (!data.safe_id) errors.push("Safe selection is required");
    if (!data.client_name.trim()) errors.push("Client name is required");
    if (!data.pickup_address.trim()) errors.push("Pickup address is required");
    if (!data.delivery_address.trim())
      errors.push("Delivery address is required");
    if (!data.scheduled_pickup) errors.push("Pickup time is required");
    if (!data.scheduled_delivery) errors.push("Delivery time is required");

    // Safe availability validation
    const selectedSafe = availableSafes.find(
      (safe) => safe.id === data.safe_id
    );
    if (data.safe_id && !selectedSafe) {
      errors.push("Selected safe is not available");
    } else if (selectedSafe) {
      if (selectedSafe.status !== "active") {
        errors.push(`Safe ${selectedSafe.serial_number} is not active`);
      }
      if (selectedSafe.battery_level < 20) {
        warnings.push(
          `Safe ${selectedSafe.serial_number} has low battery (${selectedSafe.battery_level}%)`
        );
      }
    }

    // Time validation
    const now = new Date();
    const pickupTime = new Date(data.scheduled_pickup);
    const deliveryTime = new Date(data.scheduled_delivery);

    if (pickupTime <= now) {
      errors.push("Pickup time must be in the future");
    }

    if (deliveryTime <= pickupTime) {
      errors.push("Delivery time must be after pickup time");
    }

    const timeDiff = deliveryTime.getTime() - pickupTime.getTime();
    const minDuration = 30 * 60 * 1000; // 30 minutes minimum

    if (timeDiff < minDuration) {
      errors.push("Minimum trip duration is 30 minutes");
    }

    // Contact validation
    if (data.client_phone && !this.isValidPhone(data.client_phone)) {
      errors.push("Invalid client phone number");
    }

    if (data.client_email && !this.isValidEmail(data.client_email)) {
      errors.push("Invalid client email address");
    }

    return {
      isValid: errors.length === 0,
      errors,
      warnings,
    };
  }

  // Check for scheduling conflicts
  async checkSchedulingConflicts(
    safeId: string,
    pickupTime: string,
    deliveryTime: string,
    excludeTripId?: string
  ): Promise<any[]> {
    try {
      console.log("ðŸ” Checking conflicts for:", {
        safeId,
        pickupTime,
        deliveryTime,
        excludeTripId,
      });

      let query = supabase
        .from("trips")
        .select("id, client_name, scheduled_pickup, scheduled_delivery")
        .eq("safe_id", safeId)
        .in("status", ["pending", "in_transit"]);

      if (excludeTripId) {
        query = query.neq("id", excludeTripId);
      }

      console.log("ðŸ“¡ Executing Supabase query...");
      const { data, error } = await query;

      if (error) {
        console.error("âŒ Conflict check query error:", error);
        // Don't block trip creation on conflict check errors
        return [];
      }

      console.log("ðŸ“Š Conflict check results:", data);

      if (!data || data.length === 0) {
        console.log("âœ… No existing trips to conflict with");
        return [];
      }

      const newPickup = new Date(pickupTime);
      const newDelivery = new Date(deliveryTime);

      console.log("ðŸ“… New trip times:", { newPickup, newDelivery });

      const conflicts = data.filter((trip) => {
        const existingPickup = new Date(trip.scheduled_pickup);
        const existingDelivery = new Date(trip.scheduled_delivery);

        // Check for time overlap
        const hasConflict =
          newPickup < existingDelivery && newDelivery > existingPickup;

        if (hasConflict) {
          console.log("âš ï¸ Conflict found with trip:", trip.id);
        }

        return hasConflict;
      });

      console.log(
        `âœ… Conflict check complete: ${conflicts.length} conflicts found`
      );
      return conflicts;
    } catch (error) {
      console.error("ðŸ’¥ Exception in conflict check:", error);
      // Don't block trip creation on conflict check errors
      return [];
    }
  }

  // Send combined trip confirmation + tracking email
  private async sendTripConfirmationEmail(trip: Trip) {
    try {
      if (!trip.client_email) {
        console.log("No client email provided for trip:", trip.id);
        return;
      }

      console.log("Sending confirmation email to:", trip.client_email);

      // Generate tracking URL if customer tracking is enabled
      const trackingUrl =
        trip.customer_tracking_enabled && trip.tracking_token
          ? this.generateTrackingUrl(trip.tracking_token)
          : null;

      if (trackingUrl) {
        console.log("Including tracking URL:", trackingUrl);
      }

      const { data, error } = await supabase.functions.invoke(
        "send-trip-confirmation", // One function for both
        {
          body: {
            to: trip.client_email,
            trip_id: trip.id,
            client_name: trip.client_name,
            pickup_address: trip.pickup_address,
            delivery_address: trip.delivery_address,
            scheduled_pickup: trip.scheduled_pickup,
            scheduled_delivery: trip.scheduled_delivery,
            special_instructions: trip.special_instructions,
            requires_signature: trip.requires_signature || false,
            priority: trip.priority || "normal",
            safe_serial: "Unknown",
            tracking_url: trackingUrl, // NEW: Include tracking URL
          },
        }
      );

      if (error) {
        console.error("Error sending confirmation email:", error);
      } else {
        console.log("Confirmation email sent successfully:", data);
      }
    } catch (error) {
      console.error("Exception sending confirmation email:", error);
    }
  }

  // Generate customer tracking URL
  generateTrackingUrl(trackingToken: string): string {
    const baseUrl = window.location.origin;
    return `${baseUrl}/track/${trackingToken}`;
  }

  // Get trip by tracking token (public access)
  // In your dataService.ts file, update this function:

  async getTripByTrackingToken(trackingToken: string) {
    try {
      const { data, error } = await supabase
        .from("trips")
        .select(
          `
        id,
        client_name,
        pickup_address,
        delivery_address,
        status,
        scheduled_pickup,
        scheduled_delivery,
        actual_pickup_time,
        actual_delivery_time,
        priority,
        special_instructions,
        requires_signature,
        created_at,
        updated_at,
        safe_id,
        safes!inner(
          id,
          serial_number,
          status,
          battery_level,
          last_update,
          tracknetics_device_id,
          tracking_device_id
        )
      `
        )
        .eq("tracking_token", trackingToken)
        .eq("customer_tracking_enabled", true)
        .single();

      if (error) {
        return { success: false, error: error.message };
      }

      // Transform the data to match our interface (safes is returned as array, we need single object)
      const transformedData = {
        ...data,
        safes: Array.isArray(data.safes) ? data.safes[0] : data.safes,
      };

      return { success: true, trip: transformedData };
    } catch (err: any) {
      console.error("Error fetching trip by tracking token:", err);
      return { success: false, error: "Failed to load tracking information" };
    }
  }

  // Enable/disable customer tracking for a trip
  async toggleCustomerTracking(tripId: string, enabled: boolean) {
    try {
      const { data, error } = await supabase
        .from("trips")
        .update({
          customer_tracking_enabled: enabled,
          updated_at: new Date().toISOString(),
        })
        .eq("id", tripId)
        .select()
        .single();

      if (error) {
        return { success: false, error: error.message };
      }

      return { success: true, trip: data };
    } catch (err) {
      console.error("Error toggling customer tracking:", err);
      return { success: false, error: "Failed to update tracking settings" };
    }
  }

  async updateSafeStatus(safeId: string, updates: { status: SafeStatus }) {
    const { data, error } = await supabase
      .from("safes")
      .update(updates)
      .eq("id", safeId)
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return { success: true, safe: data };
  }

  async updateTripStatus(tripId: string, status: TripStatus) {
    const { data, error } = await supabase
      .from("trips")
      .update({
        status,
        updated_at: new Date().toISOString(),
        // Set actual times when status changes
        ...(status === "in_transit" && {
          actual_pickup_time: new Date().toISOString(),
        }),
        ...(status === "delivered" && {
          actual_delivery_time: new Date().toISOString(),
        }),
      })
      .eq("id", tripId)
      .select("*, safes(serial_number)")
      .single();

    if (error) {
      throw new Error(error.message);
    }

    // Send status update email if customer tracking is enabled
    if (data.customer_tracking_enabled && data.client_email) {
      await this.sendStatusUpdateEmail(data, status);
    }

    return { success: true, trip: data };
  }

  // Send status update email
  private async sendStatusUpdateEmail(trip: any, newStatus: string) {
    try {
      console.log(
        `Sending status update email: ${newStatus} to ${trip.client_email}`
      );

      const statusMessages = {
        in_transit:
          "Your items have been securely collected and are now in transit",
        delivered: "Your secure transport has been completed successfully",
        cancelled: "Your secure transport has been cancelled",
      };

      // Get current session for auth headers
      const {
        data: { session },
      } = await supabase.auth.getSession();

      const { error } = await supabase.functions.invoke(
        "send-customer-tracking", // Reuse same function
        {
          headers: {
            Authorization: `Bearer ${session?.access_token}`,
          },
          body: {
            to: trip.client_email,
            trip_id: trip.id,
            client_name: trip.client_name,
            pickup_address: trip.pickup_address,
            delivery_address: trip.delivery_address,
            scheduled_pickup: trip.scheduled_pickup,
            scheduled_delivery: trip.scheduled_delivery,
            special_instructions: trip.special_instructions,
            priority: trip.priority || "normal",
            tracking_url: this.generateTrackingUrl(trip.tracking_token),
            status_update: true, // Flag for status update email
            new_status: newStatus,
            status_message:
              statusMessages[newStatus as keyof typeof statusMessages],
          },
        }
      );

      if (error) {
        console.error("Error sending status update email:", error);
      } else {
        console.log("Status update email sent successfully");
      }
    } catch (error) {
      console.error("Exception sending status update email:", error);
    }
  }

  // Update an existing trip
  async updateTrip(
    tripId: string,
    updates: Partial<TripBookingData>
  ): Promise<{ success: boolean; trip?: Trip; error?: string }> {
    try {
      // If updating schedule, check for conflicts
      if (
        updates.safe_id ||
        updates.scheduled_pickup ||
        updates.scheduled_delivery
      ) {
        const { data: currentTrip } = await supabase
          .from("trips")
          .select("safe_id, scheduled_pickup, scheduled_delivery")
          .eq("id", tripId)
          .single();

        if (currentTrip) {
          const safeId = updates.safe_id || currentTrip.safe_id;
          const pickupTime =
            updates.scheduled_pickup || currentTrip.scheduled_pickup;
          const deliveryTime =
            updates.scheduled_delivery || currentTrip.scheduled_delivery;

          const conflicts = await this.checkSchedulingConflicts(
            safeId,
            pickupTime,
            deliveryTime,
            tripId
          );

          if (conflicts.length > 0) {
            return {
              success: false,
              error: `Scheduling conflict detected with existing trip`,
            };
          }
        }
      }

      const { data: updatedTrip, error } = await supabase
        .from("trips")
        .update({
          ...updates,
          updated_at: new Date().toISOString(),
        })
        .eq("id", tripId)
        .select()
        .single();

      if (error) {
        return { success: false, error: error.message };
      }

      return { success: true, trip: updatedTrip };
    } catch (error) {
      console.error("Error updating trip:", error);
      return {
        success: false,
        error: "Failed to update trip. Please try again.",
      };
    }
  }

  // Cancel a trip
  async cancelTrip(
    tripId: string,
    cancelReason?: string
  ): Promise<{ success: boolean; error?: string }> {
    try {
      const { error } = await supabase
        .from("trips")
        .update({
          status: "cancelled",
          cancellation_reason: cancelReason,
          cancelled_at: new Date().toISOString(),
          updated_at: new Date().toISOString(),
        })
        .eq("id", tripId);

      if (error) {
        return { success: false, error: error.message };
      }

      return { success: true };
    } catch (error) {
      console.error("Error cancelling trip:", error);
      return {
        success: false,
        error: "Failed to cancel trip. Please try again.",
      };
    }
  }

  // Setup automatic real-time subscriptions
  setupRealtimeSubscriptions() {
    const user = currentUser.value;
    if (!user) return;

    // Subscribe to safes - RLS filters automatically
    this.safesSubscription = supabase
      .channel("safes-changes")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "safes" },
        (payload) => {
          console.log("Safe update:", payload);
          if (payload.eventType === "INSERT") {
            dataActions.addSafe(payload.new as Safe);
          } else if (payload.eventType === "UPDATE") {
            dataActions.updateSafe(
              payload.new.id,
              payload.new as Partial<Safe>
            );
          }
        }
      )
      .subscribe();

    // Subscribe to trips - RLS filters automatically
    this.tripsSubscription = supabase
      .channel("trips-changes")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "trips" },
        (payload) => {
          console.log("Trip update:", payload);
          if (payload.eventType === "INSERT") {
            dataActions.addTrip(payload.new as Trip);
          } else if (payload.eventType === "UPDATE") {
            dataActions.updateTrip(
              payload.new.id,
              payload.new as Partial<Trip>
            );
          }
        }
      )
      .subscribe();
  }

  cleanup() {
    // Clean up subscriptions
    if (this.safesSubscription) {
      supabase.removeChannel(this.safesSubscription);
    }
    if (this.tripsSubscription) {
      supabase.removeChannel(this.tripsSubscription);
    }
  }

  // Utility functions
  private isValidEmail(email: string): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  private isValidPhone(phone: string): boolean {
    // Remove spaces, dashes, parentheses for validation
    const cleanPhone = phone.replace(/[\s\-\(\)]/g, "");

    // South African phone number patterns:
    // Mobile: 071, 072, 073, 074, 076, 078, 079, 081, 082, 083, 084
    // Landline: 010, 011, 012, 013, 014, 015, 016, 017, 018, 021, 022, 023, 024, 027, 028, 031, 032, 033, 034, 035, 036, 037, 038, 039, 041, 042, 043, 044, 045, 046, 047, 048, 049, 051, 053, 054, 056, 057, 058
    // International: +27

    const southAfricanPatterns = [
      /^0[7-8][0-9]\d{7}$/, // Mobile: 071, 072, etc (10 digits total)
      /^0[1-6]\d{8}$/, // Landline: 010, 011, etc (10 digits total)
      /^\+27[7-8][0-9]\d{7}$/, // International mobile: +27 71, +27 82, etc
      /^\+27[1-6]\d{8}$/, // International landline: +27 11, +27 21, etc
      /^27[7-8][0-9]\d{7}$/, // International mobile without +: 27 71, 27 82, etc
      /^27[1-6]\d{8}$/, // International landline without +: 27 11, 27 21, etc
    ];

    // Test against South African patterns
    for (const pattern of southAfricanPatterns) {
      if (pattern.test(cleanPhone)) {
        return true;
      }
    }

    // Fallback: Allow any reasonable phone number format (more permissive)
    // This catches any other valid international formats
    const generalPattern = /^[\+]?[\d\s\-\(\)]{7,15}$/;
    return generalPattern.test(cleanPhone);
  }

  // 1. CLIENT: Booking confirmation (with tracking link)
  private async sendClientBookingConfirmation(trip: Trip) {
    try {
      if (!trip.client_email) return;

      console.log(
        "ðŸ“§ Sending booking confirmation to client:",
        trip.client_email
      );

      const trackingUrl =
        trip.customer_tracking_enabled && trip.tracking_token
          ? this.generateTrackingUrl(trip.tracking_token)
          : null;

      const emailPromise = supabase.functions.invoke(
        "send-client-booking-confirmation",
        {
          body: {
            to: trip.client_email,
            client_name: trip.client_name,
            trip_id: trip.id,
            pickup_address: trip.pickup_address,
            delivery_address: trip.delivery_address,
            recipient_name: trip.recipient_name,
            scheduled_pickup: trip.scheduled_pickup,
            scheduled_delivery: trip.scheduled_delivery,
            tracking_url: trackingUrl,
            priority: trip.priority || "normal",
          },
        }
      );

      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error("timeout")), 8000)
      );

      await Promise.race([emailPromise, timeoutPromise]).catch(() => {
        console.warn("Email timeout - continuing");
      });
    } catch (error) {
      console.error("Client email error:", error);
    }
  }

  // 2. RECIPIENT: Driver arriving notification
  // (Called from mobile app when driver clicks "I've Arrived")
  async sendRecipientArrivalNotification(trip: Trip) {
    try {
      if (!trip.recipient_email) return;

      console.log(
        "ðŸ“§ Sending arrival notification to recipient:",
        trip.recipient_email
      );

      // OPTIONAL: Include tracking link for recipient
      // const trackingUrl = this.generateTrackingUrl(trip.tracking_token);

      const emailPromise = supabase.functions.invoke("send-recipient-arrival", {
        body: {
          to: trip.recipient_email,
          recipient_name: trip.recipient_name,
          delivery_address: trip.delivery_address,
          client_name: trip.client_name,
          // tracking_url: trackingUrl, // OPTIONAL: Uncomment if you want recipient to track
        },
      });

      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error("timeout")), 8000)
      );

      await Promise.race([emailPromise, timeoutPromise]).catch(() => {
        console.warn("Email timeout - continuing");
      });
    } catch (error) {
      console.error("Recipient arrival email error:", error);
    }
  }

  // 3. CLIENT: Delivery completed confirmation
  async sendClientDeliveryConfirmation(trip: Trip) {
    try {
      if (!trip.client_email) return;

      console.log(
        "ðŸ“§ Sending delivery confirmation to client:",
        trip.client_email
      );

      const emailPromise = supabase.functions.invoke(
        "send-delivery-confirmation",
        {
          body: {
            to: trip.client_email,
            client_name: trip.client_name,
            trip_id: trip.id,
            recipient_name: trip.recipient_name,
            delivery_address: trip.delivery_address,
            delivered_at: new Date().toISOString(),
          },
        }
      );

      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error("timeout")), 8000)
      );

      await Promise.race([emailPromise, timeoutPromise]).catch(() => {
        console.warn("Email timeout - continuing");
      });
    } catch (error) {
      console.error("Delivery confirmation email error:", error);
    }
  }
}

export const dataService = new DataService();
</file>

<file path="src/services/mobileUsers.ts">
import { supabase } from "../lib/supabase";

export interface CreateMobileUserData {
  safe_id: string;
  driver_name?: string;
}

export interface MobileUserCredentials {
  username: string;
  password: string;
}

class MobileUserService {
  // Generate username from safe serial number
  generateUsername(serialNumber: string): string {
    // Convert "GS-2024-001" to "gs2024001_driver"
    return serialNumber.toLowerCase().replace(/[^a-z0-9]/g, "") + "_driver";
  }

  // Generate secure password
  generatePassword(): string {
    const chars =
      "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%^&*";
    let password = "";
    for (let i = 0; i < 12; i++) {
      password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
  }

  // Hash password for storage
  private async hashPassword(password: string): Promise<string> {
    // Simple hash for demo - in production use proper bcrypt
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hash))
      .map((b) => b.toString(16).padStart(2, "0"))
      .join("");
  }

  // Create mobile app user
  async createMobileUser(
    safeId: string,
    serialNumber: string,
    driverName?: string
  ): Promise<{
    success: boolean;
    credentials?: MobileUserCredentials;
    error?: string;
  }> {
    try {
      // Generate credentials
      const username = this.generateUsername(serialNumber);
      const password = this.generatePassword();
      const passwordHash = await this.hashPassword(password);

      // Get current user for created_by
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        return { success: false, error: "User not authenticated" };
      }

      // Create mobile user record
      const { error } = await supabase
        .from("mobile_users")
        .insert({
          safe_id: safeId,
          username,
          password_hash: passwordHash,
          driver_name: driverName,
          created_by: user.id,
        })
        .select()
        .single();

      if (error) {
        console.error("Failed to create mobile user:", error);
        return { success: false, error: error.message };
      }

      return {
        success: true,
        credentials: { username, password },
      };
    } catch (err) {
      console.error("Exception creating mobile user:", err);
      return { success: false, error: "Failed to create mobile user" };
    }
  }

  // Deactivate mobile user (when safe is deactivated)
  async deactivateMobileUser(
    safeId: string
  ): Promise<{ success: boolean; error?: string }> {
    try {
      const { error } = await supabase
        .from("mobile_users")
        .update({
          is_active: false,
          updated_at: new Date().toISOString(),
        })
        .eq("safe_id", safeId);

      if (error) {
        return { success: false, error: error.message };
      }

      return { success: true };
    } catch (err) {
      return { success: false, error: "Failed to deactivate mobile user" };
    }
  }

  // Get mobile user for safe
  async getMobileUserBySafe(safeId: string) {
    try {
      const { data, error } = await supabase
        .from("mobile_users")
        .select("*")
        .eq("safe_id", safeId)
        .eq("is_active", true)
        .single();

      if (error && error.code !== "PGRST116") {
        // Not found is ok
        console.error("Failed to get mobile user:", error);
        return null;
      }

      return data;
    } catch (err) {
      console.error("Exception getting mobile user:", err);
      return null;
    }
  }
}

export const mobileUserService = new MobileUserService();
</file>

<file path="src/services/tracknetics.ts">
import { supabase } from "../lib/supabase";

interface TrackneticsCredentials {
  username: string;
  password: string;
  apiKey?: string;
}

interface LoginResponse {
  state: string;
  userInfo?: {
    userID: string;
    userName: string;
    loginName: string;
    timeZone: string;
    address: string;
    cellPhone: string;
    key: string;
  };
}

interface DeviceInfo {
  id: string;
  sn: string; // IMEI
  name: string;
  status: string;
  speed?: string;
}

interface LocationData {
  state: string;
  positionTime?: string;
  lat?: string;
  lng?: string;
  speed?: string;
  course?: string;
  isStop?: string;
  stm?: string;
  isGPS?: string;
  status?: string;
}

class TrackneticsService {
  private credentials: TrackneticsCredentials;
  private currentSession: { userID?: string; key?: string } | null = null;

  constructor() {
    this.credentials = {
      username: import.meta.env.VITE_TRACKNETICS_USERNAME || "",
      password: import.meta.env.VITE_TRACKNETICS_PASSWORD || "",
      apiKey: import.meta.env.VITE_TRACKNETICS_API_KEY || "",
    };
  }

  // Make API call through Supabase Edge Function proxy
  private async apiCall(
    operation: string,
    params: Record<string, any> = {}
  ): Promise<any> {
    try {
      const { data, error } = await supabase.functions.invoke(
        "tracknetics-proxy",
        {
          body: {
            operation,
            params,
          },
        }
      );

      if (error) {
        console.error("Proxy call error:", error);
        throw new Error(`Proxy error: ${error.message}`);
      }

      return data;
    } catch (err) {
      console.error("API call failed:", err);
      throw err;
    }
  }

  // Login and get authentication key
  async login(): Promise<{ success: boolean; error?: string }> {
    try {
      console.log("ðŸ” Logging into Tracknetics via proxy...");

      const data: LoginResponse = await this.apiCall("Login", {
        name: this.credentials.username,
        pass: this.credentials.password,
      });

      console.log("ðŸ” Tracknetics login response:", data);

      if (data.state === "0" && data.userInfo) {
        this.currentSession = {
          userID: data.userInfo.userID,
          key: data.userInfo.key,
        };
        console.log("ðŸ”‘ Session key:", data.userInfo.key);
        console.log("âœ… Tracknetics login successful");
        return { success: true };
      } else {
        console.error("âŒ Tracknetics login failed:", data);
        const errorMessage = this.getErrorMessage(data.state);
        return { success: false, error: `Login failed: ${errorMessage}` };
      }
    } catch (error: any) {
      console.error("âŒ Tracknetics login error:", error);
      return {
        success: false,
        error: error.message || "Network error during login",
      };
    }
  }

  // Ensure we have a valid session
  private async ensureAuthenticated(): Promise<boolean> {
    if (!this.currentSession?.key) {
      const loginResult = await this.login();
      return loginResult.success;
    }
    return true;
  }

  // Get list of devices
  async getDeviceList(): Promise<{
    success: boolean;
    devices?: DeviceInfo[];
    error?: string;
  }> {
    if (
      !(await this.ensureAuthenticated()) ||
      !this.currentSession?.userID ||
      !this.currentSession?.key
    ) {
      return { success: false, error: "Authentication failed" };
    }

    try {
      console.log("ðŸ“± Getting device list...");

      const data = await this.apiCall("GetDeviceList", {
        ID: this.currentSession.userID,
        PageNo: 1,
        PageCount: 100,
        Key: this.currentSession.key,
      });

      console.log("ðŸ“± Device list response:", data);

      if (data.state === "0") {
        return { success: true, devices: data.arr || [] };
      } else {
        const errorMessage = this.getErrorMessage(data.state);
        return {
          success: false,
          error: `Failed to get devices: ${errorMessage}`,
        };
      }
    } catch (error: any) {
      console.error("âŒ Error getting device list:", error);
      return {
        success: false,
        error: error.message || "Network error getting device list",
      };
    }
  }

  // Get real-time location for a device by ID
  async getDeviceLocation(
    deviceId: string
  ): Promise<{ success: boolean; location?: LocationData; error?: string }> {
    if (!(await this.ensureAuthenticated()) || !this.currentSession?.key) {
      return { success: false, error: "Authentication failed" };
    }

    try {
      console.log("ðŸ“ Getting location for device:", deviceId);

      const data: LocationData = await this.apiCall("GetTracking", {
        DeviceID: deviceId,
        TimeZones: "South Africa Standard Time",
        MapType: "google",
        Language: "en-us",
        Key: this.currentSession.key,
      });

      console.log("ðŸ“ Location response:", data);

      if (data.state === "0") {
        return { success: true, location: data };
      } else if (data.state === "2002") {
        return { success: false, error: "No location data available" };
      } else {
        const errorMessage = this.getErrorMessage(data.state);
        return {
          success: false,
          error: `Failed to get location: ${errorMessage}`,
        };
      }
    } catch (error: any) {
      console.error("âŒ Error getting device location:", error);
      return {
        success: false,
        error: error.message || "Network error getting location",
      };
    }
  }

  // Get location by device ID (simplified method for direct calls)
  async getLocationByDeviceId(
    deviceId: string
  ): Promise<{
    success: boolean;
    location?: {
      lat: number;
      lng: number;
      accuracy: number;
      timestamp: number;
    };
    error?: string;
  }> {
    console.log("ðŸŽ¯ Getting location for device ID:", deviceId);

    const locationResult = await this.getDeviceLocation(deviceId);

    if (!locationResult.success || !locationResult.location) {
      return { success: false, error: locationResult.error };
    }

    const location = locationResult.location;

    // Convert to standard format
    if (location.lat && location.lng) {
      const standardLocation = {
        lat: parseFloat(location.lat),
        lng: parseFloat(location.lng),
        accuracy: location.isGPS === "1" ? 10 : 100, // GPS vs LBS accuracy estimate
        timestamp: location.positionTime
          ? new Date(location.positionTime).getTime()
          : Date.now(),
      };

      console.log("ðŸŽ¯ Converted location:", standardLocation);
      return {
        success: true,
        location: standardLocation,
      };
    }

    return { success: false, error: "Invalid location data received" };
  }

  // Create geofence for delivery location
  async createDeliveryGeofence(
    deviceId: string,
    name: string,
    lat: number,
    lng: number,
    radiusMeters: number = 100
  ): Promise<{ success: boolean; geofenceId?: string; error?: string }> {
    if (!(await this.ensureAuthenticated()) || !this.currentSession?.key) {
      return { success: false, error: "Authentication failed" };
    }

    try {
      console.log("ðŸš§ Creating geofence:", name, "at", lat, lng);

      const data = await this.apiCall("SaveGeofence", {
        DeviceID: deviceId,
        GeofenceName: name,
        Remark: "Delivery Location",
        Lat: lat,
        Lng: lng,
        Radius: radiusMeters,
        GeofenceID: 0,
        MapType: "google",
        Key: this.currentSession.key,
      });

      console.log("ðŸš§ Geofence response:", data);

      if (data.state === "0") {
        return { success: true, geofenceId: data.geofenceID };
      } else {
        const errorMessage = this.getErrorMessage(data.state);
        return {
          success: false,
          error: `Failed to create geofence: ${errorMessage}`,
        };
      }
    } catch (error: any) {
      console.error("âŒ Error creating geofence:", error);
      return {
        success: false,
        error: error.message || "Network error creating geofence",
      };
    }
  }

  // Get device details by ID
  async getDeviceDetails(
    deviceId: string
  ): Promise<{ success: boolean; device?: any; error?: string }> {
    if (!(await this.ensureAuthenticated()) || !this.currentSession?.key) {
      return { success: false, error: "Authentication failed" };
    }

    try {
      console.log("ðŸ“‹ Getting device details for:", deviceId);

      const data = await this.apiCall("GetDeviceDetail", {
        DeviceID: deviceId,
        TimeZones: "South Africa Standard Time",
        Key: this.currentSession.key,
      });

      console.log("ðŸ“‹ Device details response:", data);

      if (data.state === "0") {
        return { success: true, device: data };
      } else {
        const errorMessage = this.getErrorMessage(data.state);
        return {
          success: false,
          error: `Failed to get device details: ${errorMessage}`,
        };
      }
    } catch (error: any) {
      console.error("âŒ Error getting device details:", error);
      return {
        success: false,
        error: error.message || "Network error getting device details",
      };
    }
  }

  // Get device history/playback
  async getDeviceHistory(
    deviceId: string,
    startTime: string,
    endTime: string
  ): Promise<{ success: boolean; history?: any; error?: string }> {
    if (!(await this.ensureAuthenticated()) || !this.currentSession?.key) {
      return { success: false, error: "Authentication failed" };
    }

    try {
      console.log(
        "ðŸ“Š Getting device history for:",
        deviceId,
        "from",
        startTime,
        "to",
        endTime
      );

      const data = await this.apiCall("GetDevicesHistory", {
        DeviceID: deviceId,
        StartTime: startTime,
        EndTime: endTime,
        TimeZones: "South Africa Standard Time",
        ShowLBS: 0,
        MapType: "google",
        SelectCount: 1000,
        Key: this.currentSession.key,
      });

      console.log("ðŸ“Š Device history response:", data);

      if (data.state === "0") {
        return { success: true, history: data };
      } else {
        const errorMessage = this.getErrorMessage(data.state);
        return {
          success: false,
          error: `Failed to get device history: ${errorMessage}`,
        };
      }
    } catch (error: any) {
      console.error("âŒ Error getting device history:", error);
      return {
        success: false,
        error: error.message || "Network error getting device history",
      };
    }
  }

  // Logout
  async logout(): Promise<void> {
    if (this.currentSession?.userID && this.currentSession?.key) {
      try {
        await this.apiCall("Exit", {
          ID: this.currentSession.userID,
          Key: this.currentSession.key,
        });
      } catch (error) {
        console.error("Error during logout:", error);
      }
    }
    this.currentSession = null;
  }

  // Helper to decode Tracknetics error states
  private getErrorMessage(state: string): string {
    const errorCodes: Record<string, string> = {
      "0": "Success",
      "1001": "Parameter error",
      "1002": "Program error",
      "2001": "Username or password error",
      "2002": "No result",
      "2003": "Car number already exists",
      "2004": "Fail to modify",
      "2005": "Modify success",
      "2020": "Username already exists",
      "2021": "It has sub account, cannot be deleted",
      "2022": "It has device, cannot be deleted",
      "2023": "Username does not exist",
      "3001": "KEY incorrect",
      "3004": "Maintenance...",
    };

    return errorCodes[state] || `Unknown error (${state})`;
  }
}

export const trackneticsService = new TrackneticsService();
</file>

<file path="src/store/auth.ts">
import { signal, computed } from "@preact/signals";
import type { User, AuthState } from "../types";

// Auth state signal
export const authState = signal<AuthState>({
  user: null,
  loading: true,
  isAuthenticated: false,
});

// Computed values
export const currentUser = computed(() => authState.value.user);
export const isOwner = computed(() => authState.value.user?.role === "owner");
export const isAdmin = computed(() => authState.value.user?.role === "admin");
export const isAuthenticated = computed(() => authState.value.isAuthenticated);
export const isLoading = computed(() => authState.value.loading);

// Auth actions
export const authActions = {
  setUser: (user: User | null) => {
    authState.value = {
      user,
      loading: false,
      isAuthenticated: !!user,
    };
  },

  setLoading: (loading: boolean) => {
    authState.value = {
      ...authState.value,
      loading,
    };
  },

  logout: () => {
    authState.value = {
      user: null,
      loading: false,
      isAuthenticated: false,
    };
  },

  updateUser: (updates: Partial<User>) => {
    if (authState.value.user) {
      authState.value = {
        ...authState.value,
        user: {
          ...authState.value.user,
          ...updates,
        },
      };
    }
  },
};
</file>

<file path="src/store/data.ts">
import { signal } from "@preact/signals";
import type { Safe, Trip } from "../types";

// Data signals
export const safes = signal<Safe[]>([]);
export const trips = signal<Trip[]>([]);
export const loading = signal<boolean>(false);

// Data actions
export const dataActions = {
  setSafes: (newSafes: Safe[]) => {
    safes.value = newSafes;
  },

  addSafe: (safe: Safe) => {
    safes.value = [...safes.value, safe];
  },

  updateSafe: (safeId: string, updates: Partial<Safe>) => {
    safes.value = safes.value.map((safe) =>
      safe.id === safeId ? { ...safe, ...updates } : safe
    );
  },

  setTrips: (newTrips: Trip[]) => {
    trips.value = newTrips;
  },

  addTrip: (trip: Trip) => {
    trips.value = [...trips.value, trip];
  },

  updateTrip: (tripId: string, updates: Partial<Trip>) => {
    trips.value = trips.value.map((trip) =>
      trip.id === tripId ? { ...trip, ...updates } : trip
    );
  },

  setLoading: (isLoading: boolean) => {
    loading.value = isLoading;
  },
};
</file>

<file path="src/types/index.ts">
export type UserRole = "owner" | "admin";

export interface User {
  id: string;
  email: string;
  username: string;
  role: UserRole;
  created_by?: string;
  must_change_password: boolean;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface MobileUser {
  id: string;
  safe_id: string;
  username: string;
  driver_name?: string;
  is_active: boolean;
  created_by: string;
  created_at: string;
  updated_at: string;
}

export interface Safe {
  id: string;
  serial_number: string;
  device_hash: string;
  status: SafeStatus;
  battery_level: number;
  is_locked: boolean;
  tracking_device_id?: string;
  tracknetics_device_id?: string; // Add this line
  assigned_to: string;
  last_update?: string;
  created_at: string;
  mobile_users?: MobileUser[];
}

export type SafeStatus = "active" | "inactive" | "maintenance" | "offline";

// Updated Trip interface with new optional fields
export interface Trip {
  trip: any;
  id: string;
  safe_id: string;
  client_name: string;
  client_phone?: string;
  client_email?: string;
  pickup_address: string;
  pickup_contact_name?: string;
  pickup_contact_phone?: string;
  delivery_address: string;
  delivery_contact_name?: string;
  delivery_contact_phone?: string;
  status: TripStatus;
  scheduled_pickup: string;
  scheduled_delivery: string;
  priority?: TripPriority;
  special_instructions?: string;
  delivery_notes?: string;
  requires_signature?: boolean;
  recurring_config?: {
    frequency: "daily" | "weekly" | "monthly";
    end_date?: string;
    days_of_week?: number[];
  };
  recurring_parent_id?: string;
  actual_pickup_time?: string;
  actual_delivery_time?: string;
  cancellation_reason?: string;
  cancelled_at?: string;
  tracking_token?: string;
  customer_tracking_enabled?: boolean;
  created_by: string;
  created_at: string;
  updated_at: string;
}

export type TripStatus = "pending" | "in_transit" | "delivered" | "cancelled";
export type TripPriority = "low" | "normal" | "high" | "urgent";

export interface AuthState {
  user: User | null;
  loading: boolean;
  isAuthenticated: boolean;
}
</file>

<file path="src/utils/leafletHelpers.ts">
import L from "leaflet";

// Fix Leaflet default marker icons (they break in bundlers)
export const fixLeafletIcons = () => {
  delete (L.Icon.Default.prototype as any)._getIconUrl;
  L.Icon.Default.mergeOptions({
    iconRetinaUrl:
      "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",
    iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  });
};

// Create custom colored markers
export const createCustomIcon = (color: string) => {
  return L.divIcon({
    className: "custom-div-icon",
    html: `
      <div style="
        background-color: ${color};
        width: 24px;
        height: 24px;
        border-radius: 50% 50% 50% 0;
        border: 2px solid white;
        transform: rotate(-45deg);
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      ">
        <div style="
          width: 10px;
          height: 10px;
          background-color: white;
          border-radius: 50%;
          position: absolute;
          top: 5px;
          left: 5px;
        "></div>
      </div>
    `,
    iconSize: [24, 24],
    iconAnchor: [12, 24],
  });
};

// Create arrow marker for moving vehicle
export const createArrowIcon = (color: string, rotation: number = 0) => {
  return L.divIcon({
    className: "custom-arrow-icon",
    html: `
      <div style="
        width: 0;
        height: 0;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        border-bottom: 20px solid ${color};
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));
        transform: rotate(${rotation}deg);
      "></div>
    `,
    iconSize: [24, 24],
    iconAnchor: [12, 20],
  });
};

// Initialize OpenStreetMap tile layer
export const getOpenStreetMapLayer = () => {
  return L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:
      'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19,
  });
};

// Alternative: Satellite imagery (if you want satellite view option)
export const getSatelliteLayer = () => {
  return L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    {
      attribution: "Â© Esri, Maxar, Earthstar Geographics",
      maxZoom: 19,
    }
  );
};
</file>

<file path="src/vite-env.d.ts">
/// <reference types="vite/client" />
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "skipLibCheck": true,
    "paths": {
      "react": ["./node_modules/preact/compat/"],
      "react-dom": ["./node_modules/preact/compat/"]
    },

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",
    "jsxImportSource": "preact",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from "vite";
import preact from "@preact/preset-vite";
import tailwindcss from "@tailwindcss/vite";

// https://vite.dev/config/
export default defineConfig({
  plugins: [preact(), tailwindcss()],
});
</file>

</files>
